<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет Охранника</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* [Все стили остаются без изменений] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: #0a192f; color: #e6f1ff; line-height: 1.6; }
        
        /* HEADER */
        header { 
            background: linear-gradient(135deg, #0a192f, #112240); 
            color: #64ffda; 
            padding: 1rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-bottom: 2px solid #64ffda;
        }
        /* [Все остальные стили без изменений - оставлены как в исходном файле] */
        /* ... */
    </style>
</head>
<body>
    <!-- HEADER и весь HTML остаются без изменений -->
    <header>
        <div class="logo">
            <i class="fas fa-shield-alt"></i>
            <span>Личный кабинет Охранника</span>
        </div>
        <nav>
            <ul>
                <li><a href="#" id="nav-home"><i class="fas fa-home"></i> Главная</a></li>
                <li><a href="#" id="nav-login"><i class="fas fa-sign-in-alt"></i> Вход</a></li>
                <li><a href="#" id="nav-admin" class="hidden"><i class="fas fa-user-cog"></i> Админ</a></li>
                <li><a href="#" id="nav-user" class="hidden"><i class="fas fa-user"></i> Кабинет</a></li>
                <li><a href="#" id="nav-logout" class="hidden"><i class="fas fa-sign-out-alt"></i> Выход</a></li>
            </ul>
        </nav>
    </header>

    <!-- MAIN CONTENT (без изменений) -->
    <main>
        <!-- [Весь HTML контент остается без изменений] -->
        <!-- ... -->
    </main>

    <!-- FOOTER -->
    <footer>
        <p>© 2024 Личный кабинет Охранника. Работает на Supabase.</p>
        <p style="margin-top: 10px; font-size: 0.8rem; color: #495670;"><i class="fas fa-shield-alt"></i> Безопасность и надежность</p>
    </footer>

    <!-- SUPABASE & APP -->
    <script>
        // === SUPABASE CONFIG ===
        const SUPABASE_URL = 'https://jfoeyemqztzhwur0u70x8a.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_JfOEYEmQZtZHWuR0U70x8A_xVq9EqTW';

        // === ИНИЦИАЛИЗАЦИЯ SUPABASE ===
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true
            }
        });

        // === БЕЗОПАСНЫЕ УТИЛИТЫ ===
        const app = {
            getElement: function(id) {
                const el = document.getElementById(id);
                if (!el && console) console.warn('Элемент не найден:', id);
                return el;
            },
            
            showSection: function(sectionId) {
                let fullId = sectionId.includes('-section') ? sectionId : sectionId + '-section';
                const sections = ['welcome-section', 'login-section', 'admin-section', 'user-section'];
                sections.forEach(id => {
                    const el = this.getElement(id);
                    if (el) el.classList.add('hidden');
                });
                
                const targetSection = this.getElement(fullId);
                if (targetSection) targetSection.classList.remove('hidden');
                this.updateNavigation();
            },
            
            updateNavigation: function() {
                const isLoggedIn = !!currentUser;
                const isAdmin = currentUser && allUsers.find(u => u.id === currentUser.id && u.role === 'admin');
                
                ['nav-home', 'nav-login', 'nav-admin', 'nav-user', 'nav-logout'].forEach((id, i) => {
                    const el = this.getElement(id);
                    if (el) {
                        if (id === 'nav-home') el.classList.toggle('hidden', isLoggedIn);
                        else if (id === 'nav-login') el.classList.toggle('hidden', isLoggedIn);
                        else if (id === 'nav-admin') el.classList.toggle('hidden', !isAdmin);
                        else if (id === 'nav-user') el.classList.toggle('hidden', !isLoggedIn);
                        else if (id === 'nav-logout') el.classList.toggle('hidden', !isLoggedIn);
                    }
                });
            },
            
            safeAddEventListener: function(id, event, handler) {
                const el = this.getElement(id);
                if (el) el.addEventListener(event, handler);
            },
            
            showMessage: function(elementId, text, isError = false) {
                const el = this.getElement(elementId);
                if (el) {
                    el.textContent = text;
                    el.className = `message ${isError ? 'error' : 'success'}`;
                    el.classList.remove('hidden');
                    setTimeout(() => el.classList.add('hidden'), 5000);
                }
            }
        };
        
        // === СОСТОЯНИЕ ===
        let currentUser = null;
        let allUsers = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let userViewMonth = currentMonth;
        let userViewYear = currentYear;
        let shiftsMap = {};
        let postsData = [];
        let isAdmin = false;
        let adminShiftsData = {};
        
        // === ПРЕДУСТАНОВЛЕННЫЕ ПОСТЫ ===
        const defaultPosts = [
            { number: "1", post: "Старший смены", time: "06:00" },
            { number: "2", post: "Помощник ст.смены", time: "18:00" },
            { number: "3", post: "Оператор CCTV", time: "06:00" },
            { number: "4", post: "Оператор-аналитик ТСБ", time: "08:00" },
            { number: "3.1", post: "Оператор CCTV", time: "18:00" },
            { number: "5", post: "Служебный вход", time: "07:00" },
            { number: "6", post: "Выход без покупок", time: "07:15" },
            { number: "8", post: "КСО", time: "10:00" },
            { number: "11", post: "Приёмка", time: "07:00" },
            { number: "12", post: "Интернет", time: "07:30" },
            { number: "14", post: "Выезд со стройдвора", time: "07:15" },
            { number: "15", post: "Резерв", time: "08:00" }
        ];
        
        // === ТАБЫ ===
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    const content = document.getElementById(`tab-${tabId}`);
                    if (content) content.classList.add('active');
                    
                    if (tabId === 'payments-admin' && isAdmin) loadPaymentsArchive();
                    if (tabId === 'payments-user' && currentUser) {
                        updateUserStats();
                        loadUserPaymentHistory();
                    }
                    if (tabId === 'posts' && currentUser) {
                        const dateInput = app.getElement('user-posts-date');
                        if (dateInput.value) loadPostsForDate(dateInput.value, false);
                    }
                });
            });
        }
        
        // === АУТЕНТИФИКАЦИЯ ===
        app.safeAddEventListener('login-btn', 'click', async () => {
            const email = app.getElement('login-email')?.value;
            const password = app.getElement('login-password')?.value;
            if (!email || !password) return alert('Введите email и пароль');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    console.error('Ошибка входа:', error);
                    alert('Ошибка входа: ' + error.message);
                }
            } catch (error) {
                console.error('Ошибка входа:', error);
                alert('Ошибка: ' + error.message);
            }
        });
        
        // === ЗАГРУЗКА ПОЛЬЗОВАТЕЛЕЙ ===
        async function loadUsers() {
            try {
                const { data: usersData, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('full_name');
                
                if (error) throw error;
                
                allUsers = [];
                usersData.forEach(userData => {
                    let lastName = '', firstName = '';
                    if (userData.full_name) {
                        const nameParts = userData.full_name.split(' ');
                        if (nameParts.length >= 2) {
                            lastName = nameParts[0];
                            firstName = nameParts.slice(1).join(' ');
                        } else {
                            firstName = userData.full_name;
                        }
                    }
                    
                    allUsers.push({ 
                        id: userData.id, 
                        email: userData.email,
                        role: userData.role,
                        rate: userData.rate,
                        fullName: userData.full_name,
                        lastName, 
                        firstName,
                        displayName: lastName ? `${lastName} ${firstName}` : (userData.full_name || userData.email)
                    });
                });
                
                // Список пользователей
                const container = app.getElement('users-container');
                if (container) {
                    container.innerHTML = allUsers.map(user => `
                        <div class="user-card" style="background: #112240; padding: 0.8rem; margin: 0.5rem 0; border-radius: 5px; border: 1px solid #233554;">
                            <strong style="color: #64ffda;">${user.displayName || user.email}</strong><br>
                            <small style="color: #a8b2d1;">${user.role === 'admin' ? 'Администратор' : 'Охранник'}</small><br>
                            <small style="color: #8892b0;">Ставка: ${user.rate || 0} ₽</small>
                        </div>
                    `).join('');
                }
                
                // Селект для выплат админа
                const paymentSelect = app.getElement('payment-user-admin');
                if (paymentSelect) {
                    paymentSelect.innerHTML = '<option value="">Выберите охранника</option>';
                    allUsers.forEach(user => {
                        if (user.role !== 'admin') {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = `${user.displayName} (${user.rate || 0} ₽)`;
                            paymentSelect.appendChild(option);
                        }
                    });
                }
                
                if (isAdmin && document.getElementById('tab-shifts-admin')?.classList.contains('active')) {
                    await loadAllShiftsForAdmin();
                }
                
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
            }
        }
        
        // === СОЗДАНИЕ ПОЛЬЗОВАТЕЛЯ ===
        app.safeAddEventListener('create-user-btn', 'click', async () => {
            const email = app.getElement('new-user-email')?.value;
            const password = app.getElement('new-user-password')?.value;
            const lastName = app.getElement('new-user-lastname')?.value.trim();
            const firstName = app.getElement('new-user-firstname')?.value.trim();
            const rate = parseInt(app.getElement('new-user-rate')?.value) || 1500;
            
            if (!email || !password || !lastName || !firstName) {
                alert('Заполните все поля');
                return;
            }
            
            const fullName = `${lastName} ${firstName}`;
            
            try {
                // Создаем пользователя в Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password
                });
                
                if (authError) throw authError;
                
                // Добавляем запись в таблицу users
                const { error: userError } = await supabase
                    .from('users')
                    .insert({
                        id: authData.user.id,
                        email: email,
                        role: 'user',
                        full_name: fullName,
                        rate: rate,
                        created_at: new Date().toISOString()
                    });
                
                if (userError) throw userError;
                
                ['new-user-email', 'new-user-password', 'new-user-lastname', 'new-user-firstname'].forEach(id => {
                    const el = app.getElement(id);
                    if (el) el.value = '';
                });
                app.getElement('new-user-rate').value = '1500';
                
                loadUsers();
                alert(`Охранник ${fullName} создан!`);
            } catch (error) {
                console.error('Ошибка создания пользователя:', error);
                alert('Ошибка: ' + error.message);
            }
        });
        
        // === ЗАГРУЗКА СМЕН ДЛЯ АДМИНА ===
        async function loadAllShiftsForAdmin() {
            try {
                const month = parseInt(app.getElement('selected-month')?.value || currentMonth);
                const year = parseInt(app.getElement('selected-year')?.value || currentYear);
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = firstDay.toISOString().split('T')[0];
                const endDate = lastDay.toISOString().split('T')[0];
                
                const { data: shiftsData, error } = await supabase
                    .from('shifts')
                    .select('*')
                    .gte('date', startDate)
                    .lte('date', endDate);
                
                if (error) throw error;
                
                adminShiftsData = {};
                shiftsMap = {};
                
                shiftsData.forEach(data => {
                    const userId = data.user_id;
                    const date = data.date;
                    
                    if (!adminShiftsData[userId]) adminShiftsData[userId] = {};
                    if (!shiftsMap[userId]) shiftsMap[userId] = {};
                    
                    adminShiftsData[userId][date] = {
                        type: data.type,
                        done: data.done || false,
                        paid: data.paid || false,
                        shiftId: data.id
                    };
                    
                    shiftsMap[userId][date] = {
                        type: data.type,
                        done: data.done || false,
                        paid: data.paid || false
                    };
                });
                
                renderAdminShiftsTable(month, year);
                
            } catch (error) {
                console.error('Ошибка загрузки смен для админа:', error);
                alert('Ошибка загрузки смен: ' + error.message);
            }
        }
        
        // === РЕНДЕР ТАБЛИЦЫ СМЕН АДМИНА ===
        function renderAdminShiftsTable(month, year) {
            const tableBody = app.getElement('shifts-table-body');
            const daysHeader = app.getElement('days-header');
            const monthYearHeader = app.getElement('table-month-year');
            
            if (!tableBody || !daysHeader || !monthYearHeader) return;
            
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                               'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            monthYearHeader.textContent = `${monthNames[month]} ${year}`;
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let daysHtml = '';
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
                
                daysHtml += `<th style="${dayOfWeek === 0 || dayOfWeek === 6 ? 'color: #ff6b6b;' : ''}">
                    ${day}<br><small style="font-size: 0.7rem; color: #8892b0;">${dayNames[dayOfWeek]}</small>
                </th>`;
            }
            
            // Добавляем пустые ячейки для выравнивания до 31
            for (let day = daysInMonth + 1; day <= 31; day++) {
                daysHtml += `<th style="color: #8892b0; opacity: 0.3;"><br><small style="font-size: 0.7rem; color: #8892b0;"></small></th>`;
            }
            
            daysHeader.innerHTML = daysHtml;
            
            const guards = allUsers.filter(user => user.role !== 'admin');
            let tableHtml = '';
            
            guards.forEach((guard, index) => {
                tableHtml += `<tr data-user-id="${guard.id}">`;
                tableHtml += `<td>${index + 1}</td>`;
                tableHtml += `<td><strong>${guard.displayName}</strong><br><small style="color: #8892b0;">${guard.rate || 0} ₽</small></td>`;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const shift = adminShiftsData[guard.id] ? adminShiftsData[guard.id][dateStr] : null;
                    
                    let shiftClass = '';
                    let title = 'Нет смены (клик для добавления)';
                    
                    if (shift) {
                        if (shift.type === 'regular') {
                            if (shift.paid) {
                                shiftClass = 'shift-paid';
                                title = 'Оплаченная обычная смена';
                            } else if (shift.done) {
                                shiftClass = 'shift-done';
                                title = 'Отработанная обычная смена';
                            } else {
                                shiftClass = 'shift-regular';
                                title = 'Обычная смена';
                            }
                        } else if (shift.type === 'extra') {
                            if (shift.paid) {
                                shiftClass = 'shift-paid-extra';
                                title = 'Оплаченная подработка';
                            } else if (shift.done) {
                                shiftClass = 'shift-done-extra';
                                title = 'Отработанная подработка';
                            } else {
                                shiftClass = 'shift-extra';
                                title = 'Подработка';
                            }
                        } else if (shift.type === 'dayoff') {
                            shiftClass = 'shift-dayoff';
                            title = 'Выходной';
                        } else if (shift.type === 'problem') {
                            shiftClass = 'shift-problem';
                            title = 'Проблемная смена';
                        }
                    }
                    
                    const hasShift = shift && shift.shiftId;
                    tableHtml += `
                        <td>
                            <div class="shifts-cell ${shiftClass}" 
                                data-user-id="${guard.id}" 
                                data-date="${dateStr}"
                                data-shift-id="${shift ? shift.shiftId : ''}"
                                data-shift-type="${shift ? shift.type : ''}"
                                data-done="${shift ? shift.done : false}"
                                data-paid="${shift ? shift.paid : false}"
                                title="${title}">
                                ${shift ? '' : '+'}
                                ${hasShift ? '<button class="delete-shift-btn" title="Удалить смену">×</button>' : ''}
                            </div>
                        </td>`;
                }
                
                // Добавляем пустые ячейки для выравнивания до 31
                for (let day = daysInMonth + 1; day <= 31; day++) {
                    tableHtml += `<td style="opacity: 0.3;"></td>`;
                }
                
                tableHtml += `</tr>`;
            });
            
            tableBody.innerHTML = tableHtml;
            
            // Обработка кликов по ячейкам смен
            tableBody.querySelectorAll('.shifts-cell').forEach(cell => {
                cell.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('delete-shift-btn')) {
                        handleShiftCellClick(this);
                    }
                });
            });
            
            // Обработка кликов по кнопкам удаления
            tableBody.querySelectorAll('.delete-shift-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const cell = this.closest('.shifts-cell');
                    deleteShift(cell);
                });
            });
            
            // Инициализация кнопок скролла
            const scrollLeftBtn = app.getElement('scroll-left-btn');
            const scrollRightBtn = app.getElement('scroll-right-btn');
            const tableContainer = document.querySelector('.table-responsive');
            
            if (scrollLeftBtn && tableContainer) {
                scrollLeftBtn.addEventListener('click', () => tableContainer.scrollBy({ left: -200, behavior: 'smooth' }));
            }
            if (scrollRightBtn && tableContainer) {
                scrollRightBtn.addEventListener('click', () => tableContainer.scrollBy({ left: 200, behavior: 'smooth' }));
            }
        }
        
        // === УДАЛЕНИЕ СМЕНЫ ===
        async function deleteShift(cell) {
            const shiftId = cell.getAttribute('data-shift-id');
            const userId = cell.getAttribute('data-user-id');
            const date = cell.getAttribute('data-date');
            
            if (!shiftId) {
                alert('Смены для удаления не существует');
                return;
            }
            
            if (!confirm('Удалить эту смену?')) return;
            
            try {
                const { error } = await supabase
                    .from('shifts')
                    .delete()
                    .eq('id', shiftId);
                
                if (error) throw error;
                
                // Обновляем локальные данные
                if (adminShiftsData[userId] && adminShiftsData[userId][date]) {
                    delete adminShiftsData[userId][date];
                }
                if (shiftsMap[userId] && shiftsMap[userId][date]) {
                    delete shiftsMap[userId][date];
                }
                
                // Обновляем ячейку
                cell.className = 'shifts-cell';
                cell.setAttribute('data-shift-type', '');
                cell.setAttribute('data-done', 'false');
                cell.setAttribute('data-paid', 'false');
                cell.setAttribute('data-shift-id', '');
                cell.setAttribute('title', 'Нет смены (клик для добавления)');
                cell.innerHTML = '+';
                
                alert('Смена удалена!');
            } catch (error) {
                console.error('Ошибка удаления смены:', error);
                alert('Ошибка удаления смены: ' + error.message);
            }
        }
        
        // === ОБРАБОТКА КЛИКА ПО ЯЧЕЙКЕ СМЕНЫ ===
        function handleShiftCellClick(cell) {
            const userId = cell.getAttribute('data-user-id');
            const date = cell.getAttribute('data-date');
            const currentType = cell.getAttribute('data-shift-type');
            const isDone = cell.getAttribute('data-done') === 'true';
            const isPaid = cell.getAttribute('data-paid') === 'true';
            
            if (isPaid) {
                alert('Смена уже оплачена, нельзя изменить');
                return;
            }
            
            const shiftCycle = [
                {type: 'regular', color: 'shift-regular', title: 'Обычная смена'},
                {type: 'extra', color: 'shift-extra', title: 'Подработка'},
                {type: 'dayoff', color: 'shift-dayoff', title: 'Выходной'},
                {type: 'problem', color: 'shift-problem', title: 'Проблемная смена'},
                {type: 'done', color: 'shift-done', title: 'Отработанная обычная'},
                {type: 'done-extra', color: 'shift-done-extra', title: 'Отработанная подработка'},
                null
            ];
            
            let currentIndex = shiftCycle.findIndex(item => item ? item.type === currentType : currentType === '');
            if (currentIndex === -1) currentIndex = shiftCycle.length - 1;
            const nextIndex = (currentIndex + 1) % shiftCycle.length;
            const nextItem = shiftCycle[nextIndex];
            
            cell.className = 'shifts-cell';
            if (nextItem) {
                cell.classList.add(nextItem.color);
                cell.setAttribute('data-shift-type', nextItem.type);
                cell.setAttribute('data-done', nextItem.type === 'done' || nextItem.type === 'done-extra' ? 'true' : 'false');
                cell.setAttribute('title', nextItem.title);
                cell.innerHTML = nextItem.type === 'done' || nextItem.type === 'done-extra' ? '' : '';
                if (nextItem.type && nextItem.type !== '') {
                    cell.innerHTML += '<button class="delete-shift-btn" title="Удалить смену">×</button>';
                }
            } else {
                cell.setAttribute('data-shift-type', '');
                cell.setAttribute('data-done', 'false');
                cell.setAttribute('data-paid', 'false');
                cell.setAttribute('data-shift-id', '');
                cell.setAttribute('title', 'Нет смены (клик для добавления)');
                cell.innerHTML = '+';
            }
            
            if (!adminShiftsData[userId]) adminShiftsData[userId] = {};
            if (!shiftsMap[userId]) shiftsMap[userId] = {};
            
            if (nextItem) {
                let type, done, paid;
                if (nextItem.type === 'regular') { type = 'regular'; done = false; paid = false; }
                else if (nextItem.type === 'extra') { type = 'extra'; done = false; paid = false; }
                else if (nextItem.type === 'dayoff') { type = 'dayoff'; done = false; paid = false; }
                else if (nextItem.type === 'problem') { type = 'problem'; done = false; paid = false; }
                else if (nextItem.type === 'done') { type = 'regular'; done = true; paid = false; }
                else if (nextItem.type === 'done-extra') { type = 'extra'; done = true; paid = false; }
                
                adminShiftsData[userId][date] = { type, done, paid, shiftId: adminShiftsData[userId][date]?.shiftId || null };
                shiftsMap[userId][date] = { type, done, paid };
            } else {
                delete adminShiftsData[userId][date];
                delete shiftsMap[userId][date];
            }
        }
        
        // === СОХРАНЕНИЕ ВСЕХ СМЕН АДМИНА ===
        app.safeAddEventListener('save-all-shifts-btn', 'click', async () => {
            try {
                const month = parseInt(app.getElement('selected-month')?.value || currentMonth);
                const year = parseInt(app.getElement('selected-year')?.value || currentYear);
                let changesCount = 0;
                
                // Сначала удаляем все смены за месяц
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = firstDay.toISOString().split('T')[0];
                const endDate = lastDay.toISOString().split('T')[0];
                
                const { error: deleteError } = await supabase
                    .from('shifts')
                    .delete()
                    .gte('date', startDate)
                    .lte('date', endDate);
                
                if (deleteError) throw deleteError;
                
                // Затем добавляем новые смены
                const shiftsToInsert = [];
                
                for (const userId in adminShiftsData) {
                    const userShifts = adminShiftsData[userId];
                    
                    for (const [date, shift] of Object.entries(userShifts)) {
                        // Проверяем, что дата находится в выбранном месяце
                        const shiftDate = new Date(date);
                        if (shiftDate.getMonth() === month && shiftDate.getFullYear() === year) {
                            shiftsToInsert.push({
                                user_id: userId,
                                date: date,
                                type: shift.type,
                                done: shift.done || false,
                                paid: shift.paid || false,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            });
                            changesCount++;
                        }
                    }
                }
                
                if (shiftsToInsert.length > 0) {
                    const { error: insertError } = await supabase
                        .from('shifts')
                        .insert(shiftsToInsert);
                    
                    if (insertError) throw insertError;
                }
                
                alert(`Смены сохранены успешно! Изменено: ${changesCount} записей.`);
                
            } catch (error) {
                console.error('Ошибка сохранения смен:', error);
                alert('Ошибка сохранения смен: ' + error.message);
            }
        });
        
        // === ОТМЕТИТЬ ПРОШЕДШИЕ СМЕНЫ КАК ОТРАБОТАННЫЕ ===
        app.safeAddEventListener('mark-done-past', 'click', async () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];

            try {
                // Обновляем смены до сегодняшней даты
                const { data, error } = await supabase
                    .from('shifts')
                    .update({ 
                        done: true,
                        updated_at: new Date().toISOString()
                    })
                    .lt('date', todayStr)
                    .eq('done', false)
                    .eq('paid', false)
                    .in('type', ['regular', 'extra']);

                if (error) throw error;

                alert(`Отмечены прошедшие смены (до ${todayStr})`);

                if (isAdmin && document.getElementById('tab-shifts-admin')?.classList.contains('active')) {
                    await loadAllShiftsForAdmin();
                }

            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка: ' + error.message);
            }
        });
        
        // === CSV ИМПОРТ ===
        app.safeAddEventListener('import-csv-btn', 'click', async function() {
            const fileInput = app.getElement('csv-file');
            const month = parseInt(app.getElement('csv-month').value);
            const year = parseInt(app.getElement('csv-year').value);
            const resultDiv = app.getElement('csv-result');
    
            if (!fileInput.files[0]) {
                alert('Выберите CSV файл');
                return;
            }
    
            const file = fileInput.files[0];
            const reader = new FileReader();
    
            reader.onload = async function(e) {
                try {
                    const text = e.target.result;
                    const result = await processCSV(text, month, year);
            
                    // Показываем результат
                    if (resultDiv) {
                        resultDiv.innerHTML = `
                            <div class="success">
                                <strong>Импорт завершен!</strong><br>
                                Обработано сотрудников: ${result.employeesProcessed}<br>
                                Создано смен: ${result.shiftsCreated}<br>
                                Основных (*): ${result.regularShifts}, Подработок (#): ${result.extraShifts}<br>
                                ${result.notFoundNames.length > 0 ? 'Не найдено: ' + result.notFoundNames.join(', ') : ''}
                            </div>
                        `;
                        resultDiv.classList.remove('hidden');
                    }
            
                    // Обновляем таблицу
                    if (isAdmin && document.getElementById('tab-shifts-admin')?.classList.contains('active')) {
                        await loadAllShiftsForAdmin();
                    }
            
                } catch (error) {
                    console.error('Ошибка импорта:', error);
                    alert('Ошибка импорта: ' + error.message);
                    if (resultDiv) {
                        resultDiv.innerHTML = `<div class="error">Ошибка: ${error.message}</div>`;
                        resultDiv.classList.remove('hidden');
                    }
                }
            };
    
            reader.readAsText(file);
        });

        async function processCSV(csvText, month, year) {
            // Убираем BOM символ если есть
            if (csvText.charCodeAt(0) === 0xFEFF) {
                csvText = csvText.substring(1);
            }
    
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                throw new Error('CSV файл пустой или имеет неправильный формат');
            }
    
            // Читаем заголовки (дни месяца)
            const delimiter = lines[0].includes(';') ? ';' : ',';
            const headers = lines[0].split(delimiter).map(h => h.trim());
            if (headers[0] !== 'Сотрудник' && headers[0] !== 'Sotrudnik') {
                throw new Error('Первая колонка должна называться "Сотрудник" или "Sotrudnik"');
            }
    
            const shiftsToInsert = [];
            const result = {
                employeesProcessed: 0,
                shiftsCreated: 0,
                regularShifts: 0,
                extraShifts: 0,
                notFoundNames: []
            };
    
            // Обрабатываем каждую строку (начиная со второй)
            for (let i = 1; i < lines.length; i++) {
                const cells = lines[i].split(delimiter).map(c => c.trim());
                const employeeName = cells[0];
        
                if (!employeeName) continue;
        
                // Ищем сотрудника в системе
                const employee = findEmployeeByName(employeeName);
        
                if (!employee) {
                    result.notFoundNames.push(employeeName);
                    continue;
                }
        
                result.employeesProcessed++;
        
                // Обрабатываем дни (колонки 1..31)
                for (let day = 1; day <= 31; day++) {
                    if (day >= cells.length) break;
            
                    const symbol = cells[day];
                    let shiftType = null;
            
                    // Определяем тип смены по символу
                    if (symbol === '*') {
                        shiftType = 'regular';
                        result.regularShifts++;
                    } else if (symbol === '#') {
                        shiftType = 'extra';
                        result.extraShifts++;
                    } else {
                        continue; // Пропускаем пустые или другие символы
                    }
            
                    // Формируем дату
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
                    // Добавляем смену для вставки
                    shiftsToInsert.push({
                        user_id: employee.id,
                        date: dateStr,
                        type: shiftType,
                        done: false,
                        paid: false,
                        imported: true,
                        imported_at: new Date().toISOString(),
                        created_at: new Date().toISOString()
                    });
            
                    result.shiftsCreated++;
                }
            }
    
            // Сохраняем все изменения
            if (shiftsToInsert.length > 0) {
                const { error } = await supabase
                    .from('shifts')
                    .insert(shiftsToInsert);
                
                if (error) throw error;
            }
    
            return result;
        }

        function findEmployeeByName(name) {
            // Приводим к нижнему регистру и латинице
            const searchName = cyrillicToLatin(name.toLowerCase().trim());
    
            return allUsers.find(user => {
                if (user.role === 'admin') return false;
        
                // Все имена переводим в латиницу для сравнения
                const displayNameLatin = cyrillicToLatin((user.displayName || '').toLowerCase());
                const fullNameLatin = cyrillicToLatin((user.fullName || '').toLowerCase());
                const lastNameLatin = cyrillicToLatin((user.lastName || '').toLowerCase());
                const firstNameLatin = cyrillicToLatin((user.firstName || '').toLowerCase());
        
                // Ищем совпадение в латинице
                if (displayNameLatin === searchName || fullNameLatin === searchName) {
                    return true;
                }
        
                // Ищем частичное совпадение
                if (displayNameLatin.includes(searchName) || searchName.includes(displayNameLatin)) {
                    return true;
                }
        
                // Проверяем формат "Фамилия Имя" в латинице
                const fullNameReverseLatin = `${firstNameLatin} ${lastNameLatin}`;
                if (fullNameReverseLatin === searchName || searchName.includes(fullNameReverseLatin)) {
                    return true;
                }
        
                return false;
            });
        }

        // Функция перевода кириллицы в латиницу
        function cyrillicToLatin(text) {
            const cyr = {
                'а':'a','б':'b','в':'v','г':'g','д':'d','е':'e','ё':'yo','ж':'zh',
                'з':'z','и':'i','й':'y','к':'k','л':'l','м':'m','н':'n','о':'o',
                'п':'p','р':'r','с':'s','т':'t','у':'u','ф':'f','х':'h','ц':'ts',
                'ч':'ch','ш':'sh','щ':'shch','ъ':'','ы':'y','ь':'','э':'e','ю':'yu',
                'я':'ya',
                'А':'A','Б':'B','В':'V','Г':'G','Д':'D','Е':'E','Ё':'YO','Ж':'ZH',
                'З':'Z','И':'I','Й':'Y','К':'K','Л':'L','М':'M','Н':'N','О':'O',
                'П':'P','Р':'R','С':'S','Т':'T','У':'U','Ф':'F','Х':'H','Ц':'TS',
                'Ч':'CH','Ш':'SH','Щ':'SHCH','Ъ':'','Ы':'Y','Ь':'','Э':'E','Ю':'YU',
                'Я':'YA'
            };
    
            return text.split('').map(char => cyr[char] || char).join('');
        }
        
        // === ЭКСПОРТ CSV ===
        app.safeAddEventListener('export-csv-btn', 'click', async function() {
            const month = parseInt(app.getElement('selected-month').value);
            const year = parseInt(app.getElement('selected-year').value);
    
            try {
                const csvContent = await generateCSVExport(month, year);
        
                // Создаем и скачиваем файл
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
        
                const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                                   'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
        
                link.setAttribute('href', url);
                link.setAttribute('download', `smens_${monthNames[month]}_${year}.csv`);
                link.style.visibility = 'hidden';
        
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
        
                alert('CSV файл скачан!');
        
            } catch (error) {
                console.error('Ошибка экспорта:', error);
                alert('Ошибка экспорта: ' + error.message);
            }
        });

        async function generateCSVExport(month, year) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = firstDay.toISOString().split('T')[0];
            const endDate = lastDay.toISOString().split('T')[0];
    
            // Загружаем смены за месяц
            const { data: shiftsData, error } = await supabase
                .from('shifts')
                .select('*')
                .gte('date', startDate)
                .lte('date', endDate);
            
            if (error) throw error;
    
            // Группируем смены по сотрудникам
            const shiftsByUser = {};
            shiftsData.forEach(data => {
                if (!shiftsByUser[data.user_id]) {
                    shiftsByUser[data.user_id] = {};
                }
                shiftsByUser[data.user_id][data.date] = {
                    type: data.type,
                    done: data.done,
                    paid: data.paid
                };
            });
    
            // Создаем CSV
            let csvContent = 'Sotrudnik'; // Заголовок на латинице
            const daysInMonth = lastDay.getDate();
    
            // Заголовки дней
            for (let day = 1; day <= daysInMonth; day++) {
                csvContent += `,${day}`;
            }
            csvContent += '\n';
    
            // Данные по каждому сотруднику
            const employees = allUsers.filter(u => u.role !== 'admin');
    
            employees.forEach(employee => {
                // Имя в латинице
                const name = employee.displayName || employee.fullName || `${employee.lastName} ${employee.firstName}`;
                const nameLatin = cyrillicToLatin(name);
                csvContent += nameLatin;
        
                const userShifts = shiftsByUser[employee.id] || {};
        
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const shift = userShifts[dateStr];
            
                    let symbol = ' ';
                    if (shift) {
                        // Только * и # как в импорте
                        if (shift.type === 'regular') {
                            symbol = '*'; // основная смена
                        } else if (shift.type === 'extra') {
                            symbol = '#'; // подработка
                        }
                        // Выходные, проблемные и другие - пропускаем (пусто)
                    }
            
                    csvContent += `,${symbol}`;
                }
        
                csvContent += '\n';
            });
    
            return csvContent;
        }
        
        // === ЗАГРУЗКА СМЕН ПО КНОПКЕ ===
        app.safeAddEventListener('load-all-shifts-btn', 'click', async () => {
            await loadAllShiftsForAdmin();
        });
        
        // === КНОПКИ МЕСЯЦА/ГОДА ===
        ['selected-month', 'selected-year'].forEach(id => {
            app.safeAddEventListener(id, 'change', async () => {
                if (isAdmin && document.getElementById('tab-shifts-admin')?.classList.contains('active')) {
                    await loadAllShiftsForAdmin();
                }
            });
        });

        // === ЗАГРУЗКА ВСЕХ СМЕН ПОЛЬЗОВАТЕЛЯ ПРИ ВХОДЕ ===
        async function loadUserAllShiftsOnLogin() {
            if (!currentUser) return;
            try {
                const now = new Date();
                // Загружаем смены на 7 месяцев: 3 назад, текущий, 3 вперед
                const startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                const endDate = new Date(now.getFullYear(), now.getMonth() + 4, 0);
                
                const { data: shiftsData, error } = await supabase
                    .from('shifts')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('date', startDate.toISOString().split('T')[0])
                    .lte('date', endDate.toISOString().split('T')[0]);
                
                if (error) throw error;
                
                if (!shiftsMap[currentUser.id]) shiftsMap[currentUser.id] = {};
                
                shiftsData.forEach(data => {
                    shiftsMap[currentUser.id][data.date] = {
                        type: data.type,
                        done: data.done || false,
                        paid: data.paid || false
                    };
                });
                
                // Обновляем календарь текущего месяца
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                renderUserCalendar(currentMonth, currentYear);
                
            } catch (error) {
                console.error('Ошибка загрузки всех смен:', error);
            }
        }

        // === ЗАГРУЗКА СМЕН ПОЛЬЗОВАТЕЛЯ ДЛЯ ВЫБРАННОГО МЕСЯЦА ===
        async function loadUserShiftsForMonth() {
            if (!currentUser) return;
            try {
                const month = parseInt(app.getElement('user-selected-month')?.value || userViewMonth);
                const year = parseInt(app.getElement('user-selected-year')?.value || userViewYear);
                
                // Загружаем смены на 7 месяцев для полноты отображения
                const startDate = new Date(year, month - 3, 1);
                const endDate = new Date(year, month + 4, 0);
                
                const { data: shiftsData, error } = await supabase
                    .from('shifts')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('date', startDate.toISOString().split('T')[0])
                    .lte('date', endDate.toISOString().split('T')[0]);
                
                if (error) throw error;
                
                if (!shiftsMap[currentUser.id]) shiftsMap[currentUser.id] = {};
                
                // Очищаем только диапазон 7 месяцев
                Object.keys(shiftsMap[currentUser.id]).forEach(date => {
                    if (date >= startDate.toISOString().split('T')[0] && 
                        date <= endDate.toISOString().split('T')[0]) {
                        delete shiftsMap[currentUser.id][date];
                    }
                });
                
                shiftsData.forEach(data => {
                    shiftsMap[currentUser.id][data.date] = {
                        type: data.type,
                        done: data.done || false,
                        paid: data.paid || false
                    };
                });
                
                renderUserCalendar(month, year);
                updateUserStats();
                
            } catch (error) {
                console.error('Ошибка загрузки смен:', error);
                alert('Ошибка загрузки смен: ' + error.message);
            }
        }
        
        function renderUserCalendar(month, year) {
            const container = app.getElement('user-calendar');
            if (!container || !currentUser) return;
            
            const today = new Date();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const totalDays = lastDay.getDate();
            const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            
            const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            let html = days.map(day => `<div class="calendar-header">${day}</div>`).join('');
            
            for (let i = 0; i < startDay; i++) html += `<div class="calendar-day"></div>`;
            
            for (let day = 1; day <= totalDays; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const shift = shiftsMap[currentUser.id] ? shiftsMap[currentUser.id][dateStr] : null;
                let shiftClass = '';
                
                if (shift) {
                    if (shift.type === 'regular') {
                        if (shift.paid) shiftClass = 'shift-paid';
                        else if (shift.done) shiftClass = 'shift-done';
                        else shiftClass = 'shift-regular';
                    } else if (shift.type === 'extra') {
                        if (shift.paid) shiftClass = 'shift-paid-extra';
                        else if (shift.done) shiftClass = 'shift-done-extra';
                        else shiftClass = 'shift-extra';
                    } else if (shift.type === 'dayoff') shiftClass = 'shift-dayoff';
                    else if (shift.type === 'problem') shiftClass = 'shift-problem';
                }
                
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                
                html += `
                    <div class="calendar-day" data-date="${dateStr}" style="${isToday ? 'border: 2px solid #64ffda;' : ''}">
                        <div class="day-number" style="${isToday ? 'color: #64ffda; font-size: 1.1rem;' : ''}">${day}</div>
                        ${shift ? `<div class="shift-marker ${shiftClass}"></div>` : ''}
                    </div>
                `;
            }
            
            const totalCells = 35;
            const filledCells = startDay + totalDays;
            for (let i = filledCells; i < totalCells; i++) html += `<div class="calendar-day"></div>`;
            
            container.innerHTML = html;
        }
        
        // КНОПКИ НАВИГАЦИИ МЕСЯЦА
        app.safeAddEventListener('prev-month', 'click', function() {
            let month = parseInt(app.getElement('user-selected-month').value);
            let year = parseInt(app.getElement('user-selected-year').value);
            month--;
            if (month < 0) { month = 11; year--; }
            app.getElement('user-selected-month').value = month;
            app.getElement('user-selected-year').value = year;
            loadUserShiftsForMonth();
        });
        
        app.safeAddEventListener('next-month', 'click', function() {
            let month = parseInt(app.getElement('user-selected-month').value);
            let year = parseInt(app.getElement('user-selected-year').value);
            month++;
            if (month > 11) { month = 0; year++; }
            app.getElement('user-selected-month').value = month;
            app.getElement('user-selected-year').value = year;
            loadUserShiftsForMonth();
        });
        
        app.safeAddEventListener('load-user-shifts', 'click', () => loadUserShiftsForMonth());
        app.safeAddEventListener('user-selected-month', 'change', () => loadUserShiftsForMonth());
        app.safeAddEventListener('user-selected-year', 'change', () => loadUserShiftsForMonth());
        
        // === ШАБЛОН ПОСТОВ ===
        function renderPostsTemplate() {
            const container = app.getElement('posts-template');
            if (!container) return;
            
            let html = '';
            defaultPosts.forEach((item, index) => {
                html += `
                    <tr>
                        <td>${item.number}</td>
                        <td>${item.post}</td>
                        <td>${item.time}</td>
                        <td>
                            <button class="btn-small edit-template-btn" data-index="${index}"><i class="fas fa-edit"></i></button>
                            <button class="btn-small btn-danger delete-template-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
            
            document.querySelectorAll('.edit-template-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    editTemplatePost(index);
                });
            });
            
            document.querySelectorAll('.delete-template-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteTemplatePost(index);
                });
            });
        }
        
        function editTemplatePost(index) {
            const post = defaultPosts[index];
            const newNumber = prompt('Измените номер поста:', post.number);
            if (newNumber !== null) {
                const newPost = prompt('Измените название поста:', post.post);
                if (newPost !== null) {
                    const newTime = prompt('Измените время (формат ЧЧ:ММ):', post.time);
                    if (newTime !== null) {
                        defaultPosts[index] = { number: newNumber, post: newPost, time: newTime };
                        renderPostsTemplate();
                        alert('Шаблон обновлен!');
                    }
                }
            }
        }
        
        function deleteTemplatePost(index) {
            if (confirm('Удалить этот пост из шаблона?')) {
                defaultPosts.splice(index, 1);
                renderPostsTemplate();
                alert('Пост удален из шаблона!');
            }
        }
        
        // === ЗАГРУЗКА ПОСТОВ ПО ДАТЕ ===
        app.safeAddEventListener('load-posts-btn', 'click', async function() {
            const dateInput = app.getElement('posts-date');
            if (!dateInput || !dateInput.value) {
                alert('Выберите дату');
                return;
            }
            
            await loadPostsForDate(dateInput.value, true);
        });
        
        app.safeAddEventListener('create-template-btn', 'click', async function() {
            const dateInput = app.getElement('posts-date');
            if (!dateInput || !dateInput.value) {
                alert('Выберите дату');
                return;
            }
            
            if (!confirm(`Создать шаблон постов для даты ${dateInput.value}?`)) return;
            
            await createPostsFromTemplate(dateInput.value);
        });
        
        async function loadPostsForDate(date, isAdminView = false) {
            try {
                const { data: postsDataDB, error } = await supabase
                    .from('posts')
                    .select('*')
                    .eq('date', date)
                    .order('order', { ascending: true });
                
                if (error) throw error;
                
                postsData = [];
                postsDataDB.forEach(data => {
                    let guardDisplayName = data.guard_name || '';
                    if (guardDisplayName) {
                        const nameParts = guardDisplayName.split(' ');
                        if (nameParts.length >= 2) {
                            guardDisplayName = `${nameParts[0]} ${nameParts.slice(1).join(' ')}`;
                        }
                    }
                    
                    postsData.push({ 
                        id: data.id, 
                        ...data,
                        guardDisplayName: guardDisplayName,
                        guardId: data.guard_id
                    });
                });
                
                if (isAdminView) {
                    renderAdminPostsTable(date);
                } else {
                    renderUserPostsTable(date);
                }
            } catch (error) {
                console.error('Ошибка загрузки постов:', error);
                if (isAdminView) {
                    const container = app.getElement('posts-admin-container');
                    if (container) container.innerHTML = `<div class="error">Ошибка загрузки: ${error.message}</div>`;
                }
            }
        }
        
        function renderAdminPostsTable(date) {
            const container = app.getElement('posts-admin-container');
            if (!container) return;
            
            if (postsData.length === 0) {
                container.innerHTML = `
                    <div class="message">
                        <p>Нет постов на дату ${date}</p>
                        <button id="create-posts-btn" class="btn-success" style="margin-top: 10px;"><i class="fas fa-plus"></i> Создать из шаблона</button>
                    </div>
                `;
                
                app.safeAddEventListener('create-posts-btn', 'click', async function() {
                    await createPostsFromTemplate(date);
                });
                return;
            }
            
            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString('ru-RU');
            
            let html = `
                <h3>Посты на дату: ${formattedDate}</h3>
                <div class="table-responsive">
                    <table class="posts-table">
                        <thead>
                            <tr>
                                <th>№</th>
                                <th>Пост</th>
                                <th>Время</th>
                                <th>Охранник</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            postsData.forEach((post) => {
                html += `
                    <tr class="post-row" data-id="${post.id}">
                        <td>
                            <input type="text" value="${post.number || ''}" class="number-input" placeholder="№" style="width: 60px;">
                        </td>
                        <td>
                            <input type="text" value="${post.post || ''}" class="post-input" placeholder="Название поста" style="width: 100%;">
                        </td>
                        <td>
                            <input type="time" value="${post.time || '08:00'}" class="time-input">
                        </td>
                        <td>
                            ${renderUserSelectForPosts(post.guard_id)}
                        </td>
                        <td class="post-controls">
                            <button class="btn-success save-post-btn btn-small"><i class="fas fa-save"></i></button>
                            <button class="btn-danger delete-post-btn btn-small"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 1rem;">
                    <button id="add-new-post-btn" class="btn-secondary"><i class="fas fa-plus"></i> Добавить новую строку</button>
                    <button id="save-all-posts-btn" class="btn-success" style="margin-left: 10px;"><i class="fas fa-save"></i> Сохранить все</button>
                </div>
            `;
            
            container.innerHTML = html;
            
            app.safeAddEventListener('add-new-post-btn', 'click', function() {
                addNewPostRowToTable(date);
            });
            
            app.safeAddEventListener('save-all-posts-btn', 'click', function() {
                saveAllPosts(date);
            });
            
            document.querySelectorAll('.save-post-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('.post-row');
                    savePostRow(row, date);
                });
            });
            
            document.querySelectorAll('.delete-post-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('.post-row');
                    deletePostRow(row, date);
                });
            });
        }
        
        function renderUserSelectForPosts(selectedId = '') {
            let html = `<select class="guard-select" style="width: 100%;">`;
            html += `<option value="">Не назначен</option>`;
            allUsers.forEach(user => {
                if (user.role !== 'admin') {
                    html += `<option value="${user.id}" ${user.id === selectedId ? 'selected' : ''}>${user.displayName}</option>`;
                }
            });
            html += `</select>`;
            return html;
        }
        
        async function createPostsFromTemplate(date) {
            try {
                // Удаляем старые посты
                const { error: deleteError } = await supabase
                    .from('posts')
                    .delete()
                    .eq('date', date);
                
                if (deleteError) throw deleteError;
                
                // Создаем новые посты из шаблона
                const postsToInsert = defaultPosts.map((post, index) => ({
                    date: date,
                    number: post.number,
                    post: post.post,
                    guard_id: '',
                    guard_name: '',
                    time: post.time,
                    order: index + 1,
                    created_at: new Date().toISOString()
                }));
                
                const { error: insertError } = await supabase
                    .from('posts')
                    .insert(postsToInsert);
                
                if (insertError) throw insertError;
                
                alert('Шаблон постов создан в правильном порядке!');
                await loadPostsForDate(date, true);
                
            } catch (error) {
                console.error('Ошибка создания шаблона:', error);
                alert('Ошибка создания шаблона: ' + error.message);
            }
        }
        
        async function addNewPostRowToTable(date) {
            try {
                let maxOrder = 0;
                postsData.forEach(post => {
                    if (post.order !== undefined && post.order > maxOrder) {
                        maxOrder = post.order;
                    }
                });
                
                const { data, error } = await supabase
                    .from('posts')
                    .insert({
                        date: date,
                        number: '',
                        post: 'Новый пост',
                        guard_id: '',
                        guard_name: '',
                        time: '08:00',
                        order: maxOrder + 1,
                        created_at: new Date().toISOString()
                    })
                    .select();
                
                if (error) throw error;
                
                await loadPostsForDate(date, true);
            } catch (error) {
                console.error('Ошибка создания поста:', error);
                alert('Ошибка создания поста: ' + error.message);
            }
        }
        
        async function savePostRow(row, date) {
            const postId = row.getAttribute('data-id');
            const numberInput = row.querySelector('.number-input');
            const postInput = row.querySelector('.post-input');
            const guardSelect = row.querySelector('.guard-select');
            const timeInput = row.querySelector('.time-input');
            
            if (!postId || !numberInput || !postInput || !guardSelect || !timeInput) return;
            
            const number = numberInput.value.trim();
            const post = postInput.value.trim();
            const guardId = guardSelect.value;
            const time = timeInput.value;
            
            if (!post) {
                alert('Введите название поста');
                return;
            }
            
            const guard = allUsers.find(u => u.id === guardId);
            let guardName = guard ? guard.displayName : '';
            
            if (guard && guard.lastName && guard.firstName) {
                guardName = `${guard.lastName} ${guard.firstName}`;
            }
            
            const existingPost = postsData.find(p => p.id === postId);
            const order = existingPost ? existingPost.order : (postsData.length + 1);
            
            try {
                const { error } = await supabase
                    .from('posts')
                    .update({
                        number: number,
                        post: post,
                        guard_id: guardId,
                        guard_name: guardName,
                        time: time,
                        order: order,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', postId);
                
                if (error) throw error;
                
                alert('Пост сохранен!');
            } catch (error) {
                console.error('Ошибка сохранения:', error);
                alert('Ошибка сохранения: ' + error.message);
            }
        }
        
        async function saveAllPosts(date) {
            const rows = document.querySelectorAll('.post-row');
            let hasErrors = false;
            
            for (const row of rows) {
                const postId = row.getAttribute('data-id');
                const numberInput = row.querySelector('.number-input');
                const postInput = row.querySelector('.post-input');
                const guardSelect = row.querySelector('.guard-select');
                const timeInput = row.querySelector('.time-input');
                
                if (!postId || !numberInput || !postInput || !guardSelect || !timeInput) continue;
                
                const number = numberInput.value.trim();
                const post = postInput.value.trim();
                const guardId = guardSelect.value;
                const time = timeInput.value;
                
                if (!post) {
                    alert('Заполните название поста во всех строках');
                    hasErrors = true;
                    break;
                }
                
                const guard = allUsers.find(u => u.id === guardId);
                let guardName = guard ? guard.displayName : '';
                
                if (guard && guard.lastName && guard.firstName) {
                    guardName = `${guard.lastName} ${guard.firstName}`;
                }
                
                const existingPost = postsData.find(p => p.id === postId);
                const order = existingPost ? existingPost.order : (postsData.length + 1);
                
                try {
                    const { error } = await supabase
                        .from('posts')
                        .update({
                            number: number,
                            post: post,
                            guard_id: guardId,
                            guard_name: guardName,
                            time: time,
                            order: order,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', postId);
                    
                    if (error) throw error;
                } catch (error) {
                    console.error('Ошибка сохранения:', error);
                    alert('Ошибка сохранения: ' + error.message);
                    hasErrors = true;
                    break;
                }
            }
            
            if (!hasErrors) {
                alert('Все посты сохранены!');
                await loadPostsForDate(date, true);
            }
        }
        
        async function deletePostRow(row, date) {
            const postId = row.getAttribute('data-id');
            if (!postId) return;
            
            if (!confirm('Удалить этот пост?')) return;
            
            try {
                const { error } = await supabase
                    .from('posts')
                    .delete()
                    .eq('id', postId);
                
                if (error) throw error;
                
                await loadPostsForDate(date, true);
            } catch (error) {
                console.error('Ошибка удаления:', error);
                alert('Ошибка удаления: ' + error.message);
            }
        }
        
        // === ПОСТОВАЯ ДЛЯ ПОЛЬЗОВАТЕЛЯ ===
        app.safeAddEventListener('load-user-posts-btn', 'click', async function() {
            const dateInput = app.getElement('user-posts-date');
            if (!dateInput || !dateInput.value) {
                alert('Выберите дату');
                return;
            }
            
            await loadPostsForDate(dateInput.value, false);
        });
        
        function renderUserPostsTable(date) {
            const container = app.getElement('posts-user-container');
            if (!container) return;
            
            if (postsData.length === 0) {
                container.innerHTML = `
                    <div class="message">
                        <p>Нет постов на выбранную дату ${date}</p>
                    </div>
                `;
                return;
            }
            
            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString('ru-RU');
            
            const userPosts = postsData;
            
            let html = `
                <h3>Посты на дату: ${formattedDate}</h3>
                <div class="table-responsive">
                    <table class="posts-table">
                        <thead>
                            <tr>
                                <th>№</th>
                                <th>Пост</th>
                                <th>Время</th>
                                <th>Назначен</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            userPosts.forEach((post) => {
                const isAssignedToMe = post.guard_id === currentUser?.id;
                html += `
                    <tr>
                        <td>${post.number || ''}</td>
                        <td><strong>${post.post || ''}</strong></td>
                        <td>${post.time || ''}</td>
                        <td>
                            ${post.guardDisplayName || post.guard_name || 'Не назначен'}
                            ${isAssignedToMe ? ' <span style="color:#64ffda;">(Вы)</span>' : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // === ОБНОВЛЕНИЕ СТАТИСТИКИ ===
        function updateUserStats() {
            if (!currentUser) return;
            const user = allUsers.find(u => u.id === currentUser.id);
            if (!user) return;
            
            const rate = user.rate || 0;
            const shifts = shiftsMap[currentUser.id] || {};
            let regularCount = 0, extraCount = 0, pendingAmount = 0;
            
            Object.values(shifts).forEach(shift => {
                if (shift.type === 'regular' && shift.done && !shift.paid) {
                    regularCount++;
                    pendingAmount += rate;
                } else if (shift.type === 'extra' && shift.done && !shift.paid) {
                    extraCount++;
                    pendingAmount += rate + 100;
                }
            });
            
            const pendingTable = app.getElement('pending-payments');
            const pendingTotal = app.getElement('pending-total');
            
            if (pendingTable) {
                if (regularCount === 0 && extraCount === 0) {
                    pendingTable.innerHTML = '<tr><td colspan="4">Нет ожидающих выплат</td></tr>';
                } else {
                    pendingTable.innerHTML = '';
                    if (regularCount > 0) {
                        pendingTable.innerHTML += `
                            <tr>
                                <td>Обычные смены</td>
                                <td>${regularCount}</td>
                                <td>${rate} ₽</td>
                                <td>${regularCount * rate} ₽</td>
                            </tr>
                        `;
                    }
                    if (extraCount > 0) {
                        pendingTable.innerHTML += `
                            <tr>
                                <td>Подработки</td>
                                <td>${extraCount}</td>
                                <td>${rate + 100} ₽</td>
                                <td>${extraCount * (rate + 100)} ₽</td>
                            </tr>
                        `;
                    }
                }
            }
            
            if (pendingTotal) pendingTotal.textContent = `${pendingAmount} ₽`;
            
            const userName = app.getElement('user-full-name');
            const userPosition = app.getElement('user-position');
            const userRate = app.getElement('user-rate');
            const userEmail = app.getElement('user-email');
            
            if (userName) userName.textContent = user.lastName && user.firstName ? 
                `${user.lastName} ${user.firstName}` : user.fullName || user.email || 'Имя не указано';
            if (userPosition) userPosition.textContent = user.role === 'admin' ? 'Администратор' : 'Охранник';
            if (userRate) userRate.textContent = `${rate} ₽`;
            if (userEmail) userEmail.textContent = user.email;
        }
        
        // === ВЫПЛАТЫ АДМИНА ===
        async function loadPaymentsArchive() {
            try {
                const { data: paymentsData, error } = await supabase
                    .from('salary_payments')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                const container = app.getElement('payments-archive-admin');
                if (!container) return;
                
                if (!paymentsData || paymentsData.length === 0) {
                    container.innerHTML = '<tr><td colspan="10">Нет выплат</td></tr>';
                    return;
                }
                
                let html = '';
                paymentsData.forEach(data => {
                    const date = data.created_at ? 
                        new Date(data.created_at).toLocaleDateString('ru-RU') : 'Дата неизвестна';
                    const user = allUsers.find(u => u.id === data.user_id);
                    const rate = user ? user.rate : 0;
                    
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>${data.period_from}<br>${data.period_to}</td>
                            <td>${data.user_name || 'Неизвестно'}</td>
                            <td>${data.regular_shifts || 0}</td>
                            <td>${data.extra_shifts || 0}</td>
                            <td>${rate} ₽</td>
                            <td>${data.bonus || 0} ₽</td>
                            <td>${data.penalty || 0} ₽</td>
                            <td>${data.bonus_note || ''}</td>
                            <td><strong>${data.total_amount || 0} ₽</strong></td>
                        </tr>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Ошибка загрузки архива выплат:', error);
            }
        }
        
        // === РАСЧЕТ ВЫПЛАТ АДМИНА ===
        app.safeAddEventListener('calculate-payment-btn-admin', 'click', async () => {
            const userId = app.getElement('payment-user-admin')?.value;
            const fromDate = app.getElement('period-from-admin')?.value;
            const toDate = app.getElement('period-to-admin')?.value;
            const bonus = parseInt(app.getElement('bonus-amount-admin')?.value) || 0;
            const penalty = parseInt(app.getElement('penalty-amount-admin')?.value) || 0;
            const note = app.getElement('bonus-note-admin')?.value;
            
            if (!userId || !fromDate || !toDate) return alert('Заполните все поля');
            
            const user = allUsers.find(u => u.id === userId);
            if (!user) return alert('Охранник не найден');
            
            const rate = user.rate || 0;
            
            try {
                // Получаем смены за период
                const { data: shiftsData, error: shiftsError } = await supabase
                    .from('shifts')
                    .select('*')
                    .eq('user_id', userId)
                    .gte('date', fromDate)
                    .lte('date', toDate);
                
                if (shiftsError) throw shiftsError;
                
                let regularCount = 0, extraCount = 0, totalAmount = 0;
                const shiftsToUpdate = [];
                
                shiftsData.forEach(data => {
                    if (data.done && !data.paid) {
                        if (data.type === 'regular') {
                            regularCount++;
                            totalAmount += rate;
                        } else if (data.type === 'extra') {
                            extraCount++;
                            totalAmount += rate + 100;
                        }
                        shiftsToUpdate.push(data.id);
                    }
                });
                
                if (regularCount === 0 && extraCount === 0) {
                    alert('Нет смен для выплаты в выбранном периоде');
                    return;
                }
                
                // Обновляем смены как оплаченные
                if (shiftsToUpdate.length > 0) {
                    const { error: updateError } = await supabase
                        .from('shifts')
                        .update({ 
                            paid: true,
                            paid_at: new Date().toISOString()
                        })
                        .in('id', shiftsToUpdate);
                    
                    if (updateError) throw updateError;
                }
                
                const finalAmount = totalAmount + bonus - penalty;
                
                // Создаем запись о выплате
                const { error: paymentError } = await supabase
                    .from('salary_payments')
                    .insert({
                        user_id: userId, 
                        user_name: user.displayName || user.email,
                        period_from: fromDate, 
                        period_to: toDate,
                        regular_shifts: regularCount, 
                        extra_shifts: extraCount,
                        base_amount: totalAmount, 
                        bonus, 
                        penalty, 
                        bonus_note: note,
                        total_amount: finalAmount,
                        created_at: new Date().toISOString(),
                        admin_id: currentUser.id
                    });
                
                if (paymentError) throw paymentError;
                
                // Очищаем форму
                app.getElement('payment-user-admin').value = '';
                app.getElement('bonus-amount-admin').value = '0';
                app.getElement('penalty-amount-admin').value = '0';
                app.getElement('bonus-note-admin').value = '';
                
                const resultDiv = app.getElement('calculation-result-admin');
                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>Выплата создана!</strong><br>
                            Охранник: ${user.displayName || user.email}<br>
                            Период: ${fromDate} - ${toDate}<br>
                            Обычных: ${regularCount} × ${rate} ₽ = ${regularCount * rate} ₽<br>
                            Подработок: ${extraCount} × ${rate + 100} ₽ = ${extraCount * (rate + 100)} ₽<br>
                            Премия: +${bonus} ₽<br>
                            Удержание: -${penalty} ₽<br>
                            <strong>Итого: ${finalAmount} ₽</strong>
                        </div>
                    `;
                }
                
                await loadPaymentsArchive();
                alert(`Выплата на сумму ${finalAmount} ₽ создана для ${user.displayName}`);
                
            } catch (error) {
                console.error('Ошибка создания выплаты:', error);
                alert('Ошибка: ' + error.message);
            }
        });
        
        // === ИСТОРИЯ ВЫПЛАТ ПОЛЬЗОВАТЕЛЯ ===
        async function loadUserPaymentHistory() {
            if (!currentUser) return;
            try {
                const { data: paymentsData, error } = await supabase
                    .from('salary_payments')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                const container = app.getElement('payments-history-user');
                if (!container) return;
                
                if (!paymentsData || paymentsData.length === 0) {
                    container.innerHTML = '<tr><td colspan="9">Нет выплат</td></tr>';
                    return;
                }
                
                const user = allUsers.find(u => u.id === currentUser.id);
                const rate = user ? user.rate : 0;
                
                let html = '';
                paymentsData.forEach(data => {
                    const date = data.created_at ? 
                        new Date(data.created_at).toLocaleDateString('ru-RU') : 'Дата неизвестна';
                    
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>${data.period_from}<br>${data.period_to}</td>
                            <td>${data.regular_shifts || 0}</td>
                            <td>${data.extra_shifts || 0}</td>
                            <td>${rate} ₽</td>
                            <td>${data.bonus || 0} ₽</td>
                            <td>${data.penalty || 0} ₽</td>
                            <td>${data.bonus_note || ''}</td>
                            <td><strong>${data.total_amount || 0} ₽</strong></td>
                        </tr>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Ошибка загрузки истории выплат:', error);
            }
        }
        
        // === ИНИЦИАЛИЗАЦИЯ ===
        function init() {
            initTabs();
            
            // Навигация
            ['nav-home', 'nav-login', 'nav-admin', 'nav-user'].forEach(id => {
                app.safeAddEventListener(id, 'click', (e) => {
                    e.preventDefault();
                    app.showSection(id.replace('nav-', ''));
                });
            });
            
            app.safeAddEventListener('nav-logout', 'click', async () => {
                const { error } = await supabase.auth.signOut();
                if (error) console.error('Ошибка выхода:', error);
            });
            
            app.safeAddEventListener('go-to-login', 'click', (e) => {
                e.preventDefault();
                app.showSection('login-section');
            });
            
            // Установка начальных дат
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            app.getElement('selected-month').value = currentMonth;
            app.getElement('selected-year').value = currentYear;
            app.getElement('user-selected-month').value = currentMonth;
            app.getElement('user-selected-year').value = currentYear;
            app.getElement('csv-month').value = currentMonth;
            app.getElement('csv-year').value = currentYear;
            
            const periodFrom = app.getElement('period-from-admin');
            const periodTo = app.getElement('period-to-admin');
            if (periodFrom) periodFrom.valueAsDate = firstDay;
            if (periodTo) periodTo.valueAsDate = today;
            
            const postsDate = app.getElement('posts-date');
            const userPostsDate = app.getElement('user-posts-date');
            if (postsDate) postsDate.valueAsDate = today;
            if (userPostsDate) userPostsDate.valueAsDate = today;
            
            // Рендер шаблона постов
            renderPostsTemplate();
            
            app.showSection('welcome-section');
        }
        
        // === ОБРАБОТЧИК АУТЕНТИФИКАЦИИ ===
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                
                await loadUsers();
                
                const user = allUsers.find(u => u.id === currentUser.id);
                isAdmin = user && user.role === 'admin';
                
                if (isAdmin) {
                    app.showSection('admin-section');
                    await loadAllShiftsForAdmin();
                    loadPaymentsArchive();
                } else {
                    await loadUserAllShiftsOnLogin();
                    updateUserStats();
                    loadUserPaymentHistory();
                    app.showSection('user-section');
                }
                
                app.updateNavigation();
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                isAdmin = false;
                app.showSection('welcome-section');
                app.updateNavigation();
            } else if (event === 'INITIAL_SESSION' && session) {
                currentUser = session.user;
                
                await loadUsers();
                
                const user = allUsers.find(u => u.id === currentUser.id);
                isAdmin = user && user.role === 'admin';
                
                if (isAdmin) {
                    app.showSection('admin-section');
                    await loadAllShiftsForAdmin();
                    loadPaymentsArchive();
                } else if (currentUser) {
                    await loadUserAllShiftsOnLogin();
                    updateUserStats();
                    loadUserPaymentHistory();
                    app.showSection('user-section');
                }
                
                app.updateNavigation();
            }
        });
        
        // ЗАПУСК
        document.addEventListener('DOMContentLoaded', init);
        
        // Отображение ошибок в консоли
        window.addEventListener('error', function(e) {
            console.error('Ошибка:', e.error);
            console.error('Сообщение:', e.message);
            console.error('Файл:', e.filename);
            console.error('Строка:', e.lineno, 'Колонка:', e.colno);
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Необработанное обещание:', e.reason);
        });
    </script>
</body>
</html>