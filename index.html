<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoIP App</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
    <style>
        body { font-family: Arial; text-align: center; }
        button { font-size: 20px; margin: 10px; padding: 20px; }
        input { font-size: 18px; margin: 10px; }
    </style>
</head>
<body>
    <h1>VoIP App</h1>
    <div id="login">
        <input type="email" id="email" placeholder="Email (например, t1@test.com)">
        <input type="password" id="password" placeholder="Пароль (111111)">
        <button onclick="login()">Войти</button>
    </div>
    <div id="app" style="display:none;">
        <h2>Звонки</h2>
        <button onclick="callUser('t1@test.com')">Позвонить t1@test.com</button>
        <button onclick="callUser('t2@test.com')">Позвонить t2@test.com</button>
        <button onclick="hangup()">Повесить</button>
        <div id="status"></div>
    </div>

    <script>
        // Firebase config (твои ключи)
        const firebaseConfig = {
            apiKey: "AIzaSyB_oIgWVcb_56VAdWaVl7GHY3bj75Vt-Wo",
            authDomain: "voip-app-12345.firebaseapp.com",
            projectId: "voip-app-12345",
            storageBucket: "voip-app-12345.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let localStream, remoteStream, peerConnection;
        const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                listenForCalls(user.uid);
            } else {
                document.getElementById('login').style.display = 'block';
                document.getElementById('app').style.display = 'none';
            }
        });

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        async function callUser(targetEmail) {
            const user = auth.currentUser;
            if (!user) return;
            const targetUser = await db.collection('users').where('email', '==', targetEmail).get();
            if (targetUser.empty) return alert('Пользователь не найден');
            const targetUid = targetUser.docs[0].id;

            peerConnection = new RTCPeerConnection(configuration);
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    db.collection('users').doc(user.uid).update({
                        iceCandidates: firebase.firestore.FieldValue.arrayUnion(event.candidate.toJSON())
                    });
                }
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            await db.collection('users').doc(user.uid).set({
                offer: offer,
                targetUid: targetUid,
                email: user.email
            });
            document.getElementById('status').textContent = 'Звоним...';
        }

        async function listenForCalls(uid) {
            db.collection('users').doc(uid).onSnapshot(async doc => {
                if (!doc.exists) return;
                const data = doc.data();
                if (data.offer && !peerConnection) {
                    peerConnection = new RTCPeerConnection(configuration);
                    remoteStream = new MediaStream();
                    peerConnection.ontrack = event => {
                        remoteStream.addTrack(event.track);
                        const audio = new Audio();
                        audio.srcObject = remoteStream;
                        audio.play();
                    };
                    await peerConnection.setRemoteDescription(data.offer);
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    await db.collection('users').doc(uid).update({ answer: answer });
                    document.getElementById('status').textContent = 'Входящий звонок...';
                }
                if (data.iceCandidates) {
                    data.iceCandidates.forEach(candidate => {
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    });
                }
            });
        }

        function hangup() {
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            document.getElementById('status').textContent = '';
        }
    </script>
</body>
</html>
