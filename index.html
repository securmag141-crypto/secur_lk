<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет Охранника</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Стили остаются без изменений - для краткости оставлю как есть */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: #0a192f; color: #e6f1ff; line-height: 1.6; }
        
        /* ... остальные стили без изменений ... */
        
        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            /* ... адаптивные стили без изменений ... */
        }
    </style>
</head>
<body>
    <!-- HTML структура без изменений -->
    <header>
        <div class="logo">
            <i class="fas fa-shield-alt"></i>
            <span>Личный кабинет Охранника</span>
        </div>
        <nav>
            <ul>
                <li><a href="#" id="nav-home"><i class="fas fa-home"></i> Главная</a></li>
                <li><a href="#" id="nav-login" class="hidden"><i class="fas fa-sign-in-alt"></i> Вход</a></li>
                <li><a href="#" id="nav-admin" class="hidden"><i class="fas fa-user-cog"></i> Админ</a></li>
                <li><a href="#" id="nav-user" class="hidden"><i class="fas fa-user"></i> Кабинет</a></li>
                <li><a href="#" id="nav-logout" class="hidden"><i class="fas fa-sign-out-alt"></i> Выход</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="welcome-section" class="container hidden">
            <!-- ... содержимое без изменений ... -->
        </section>

        <section id="login-section" class="container hidden">
            <!-- ... содержимое без изменений ... -->
        </section>

        <section id="admin-section" class="container hidden">
            <!-- ... содержимое без изменений ... -->
        </section>

        <section id="user-section" class="container hidden">
            <!-- ... содержимое без изменений ... -->
        </section>
    </main>

    <footer>
        <p>© 2024 Личный кабинет Охранника. Работает на Supabase.</p>
        <p style="margin-top: 10px; font-size: 0.8rem; color: #495670;"><i class="fas fa-shield-alt"></i> Безопасность и надежность</p>
    </footer>

    <script>
        // === SUPABASE CONFIG ===
        const SUPABASE_URL = 'https://aosyccruswwkblifqiwx.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_JfOEYEmQZtZHWuR0U70x8A_xVq9EqTW';
        
        // === ИНИЦИАЛИЗАЦИЯ SUPABASE ===
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // === СОСТОЯНИЕ ===
        let currentUser = null;
        let allUsers = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let userViewMonth = currentMonth;
        let userViewYear = currentYear;
        let shiftsMap = {};
        let postsData = [];
        let isAdmin = false;
        let adminShiftsData = {};
        let currentAdminShifts = {};
        let isInitialized = false;
        
        // === ПРЕДУСТАНОВЛЕННЫЕ ПОСТЫ ===
        const defaultPosts = [
            { number: "1", post: "Старший смены", time: "06:00" },
            { number: "2", post: "Помощник ст.смены", time: "18:00" },
            { number: "3", post: "Оператор CCTV", time: "06:00" },
            { number: "4", post: "Оператор-аналитик ТСБ", time: "08:00" },
            { number: "3.1", post: "Оператор CCTV", time: "18:00" },
            { number: "5", post: "Служебный вход", time: "07:00" },
            { number: "6", post: "Выход без покупок", time: "07:15" },
            { number: "8", post: "КСО", time: "10:00" },
            { number: "11", post: "Приёмка", time: "07:00" },
            { number: "12", post: "Интернет", time: "07:30" },
            { number: "14", post: "Выезд со стройдвора", time: "07:15" },
            { number: "15", post: "Резерв", time: "08:00" }
        ];
        
        // === УТИЛИТЫ ===
        const utils = {
            getElement(id) {
                const el = document.getElementById(id);
                if (!el && console) console.warn('Элемент не найден:', id);
                return el;
            },
            
            showSection(sectionId) {
                const sections = ['welcome-section', 'login-section', 'admin-section', 'user-section'];
                sections.forEach(id => {
                    const el = this.getElement(id);
                    if (el) el.classList.add('hidden');
                });
                
                const targetSection = this.getElement(sectionId.includes('-section') ? sectionId : sectionId + '-section');
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    console.log('Показана секция:', sectionId);
                }
                this.updateNavigation();
            },
            
            updateNavigation() {
                const isLoggedIn = !!currentUser;
                const isAdminUser = currentUser && allUsers.find(u => u.id === currentUser.id && u.role === 'admin');
                
                console.log('Обновление навигации:', { isLoggedIn, isAdminUser, currentUser });
                
                const navHome = this.getElement('nav-home');
                const navLogin = this.getElement('nav-login');
                const navAdmin = this.getElement('nav-admin');
                const navUser = this.getElement('nav-user');
                const navLogout = this.getElement('nav-logout');
                
                if (navHome) navHome.classList.toggle('hidden', isLoggedIn);
                if (navLogin) navLogin.classList.toggle('hidden', isLoggedIn);
                if (navAdmin) navAdmin.classList.toggle('hidden', !isAdminUser);
                if (navUser) navUser.classList.toggle('hidden', !isLoggedIn);
                if (navLogout) navLogout.classList.toggle('hidden', !isLoggedIn);
            },
            
            showMessage(elementId, text, isError = false) {
                const el = this.getElement(elementId);
                if (el) {
                    el.textContent = text;
                    el.className = `message ${isError ? 'error' : 'success'}`;
                    el.classList.remove('hidden');
                    setTimeout(() => el.classList.add('hidden'), 5000);
                }
            },
            
            safeAddEventListener(id, event, handler) {
                const el = this.getElement(id);
                if (el) {
                    el.removeEventListener(event, handler);
                    el.addEventListener(event, handler);
                }
            }
        };
        
        // === ТАБЫ ===
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    const content = document.getElementById(`tab-${tabId}`);
                    if (content) content.classList.add('active');
                    
                    if (tabId === 'payments-admin' && isAdmin) loadPaymentsArchive();
                    if (tabId === 'payments-user' && currentUser) {
                        updateUserStats();
                        loadUserPaymentHistory();
                    }
                });
            });
        }
        
        // === АУТЕНТИФИКАЦИЯ ===
        async function handleLogin() {
            const email = utils.getElement('login-email')?.value;
            const password = utils.getElement('login-password')?.value;
    
            if (!email || !password) {
                alert('Введите email и пароль');
                return;
            }
    
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                console.log('Вход успешен:', data.user.email);
                currentUser = data.user;
                await checkUserRole();
                
            } catch (error) {
                alert('Ошибка входа: ' + error.message);
            }
        }
        
        // === ПРОВЕРКА РОЛИ ПОЛЬЗОВАТЕЛЯ ===
        async function checkUserRole() {
            if (!currentUser) {
                console.log('Нет текущего пользователя');
                return;
            }
            
            try {
                console.log('Проверка роли для пользователя:', currentUser.id);
                
                // Сначала проверяем существование пользователя в таблице users
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') { // Пользователь не найден
                        console.log('Создаем нового пользователя в базе');
                        // Создаем нового пользователя
                        const emailParts = currentUser.email.split('@')[0];
                        const { error: insertError } = await supabase
                            .from('users')
                            .insert([
                                {
                                    id: currentUser.id,
                                    email: currentUser.email,
                                    role: 'user',
                                    full_name: emailParts,
                                    rate: 1500,
                                    created_at: new Date().toISOString()
                                }
                            ]);
                        
                        if (insertError) throw insertError;
                        
                        isAdmin = false;
                    } else {
                        throw error;
                    }
                } else {
                    // Пользователь найден
                    isAdmin = data.role === 'admin';
                    currentUser = { ...currentUser, ...data };
                    console.log('Роль пользователя:', data.role, 'isAdmin:', isAdmin);
                }
                
                // Загружаем всех пользователей
                await loadUsers();
                
                // Перенаправляем в нужный раздел
                if (isAdmin) {
                    console.log('Перенаправление в админ-панель');
                    utils.showSection('admin-section');
                    await loadAllShiftsForAdmin();
                    loadPaymentsArchive();
                } else {
                    console.log('Перенаправление в личный кабинет');
                    await loadUserAllShiftsOnLogin();
                    updateUserStats();
                    loadUserPaymentHistory();
                    utils.showSection('user-section');
                }
                
                utils.updateNavigation();
                
            } catch (error) {
                console.error('Ошибка проверки роли:', error);
                alert('Ошибка проверки роли: ' + error.message);
            }
        }
        
        // === ЗАГРУЗКА ПОЛЬЗОВАТЕЛЕЙ ===
        async function loadUsers() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('full_name');
                
                if (error) throw error;
                
                allUsers = data || [];
                
                allUsers.forEach(user => {
                    let lastName = '', firstName = '';
                    if (user.full_name) {
                        const nameParts = user.full_name.split(' ');
                        if (nameParts.length >= 2) {
                            lastName = nameParts[0];
                            firstName = nameParts.slice(1).join(' ');
                        } else {
                            firstName = user.full_name;
                        }
                    }
                    user.lastName = lastName;
                    user.firstName = firstName;
                    user.displayName = lastName ? `${lastName} ${firstName}` : (user.full_name || user.email);
                });
                
                const container = utils.getElement('users-container');
                if (container) {
                    container.innerHTML = allUsers.map(user => `
                        <div class="user-card" style="background: #112240; padding: 0.8rem; margin: 0.5rem 0; border-radius: 5px; border: 1px solid #233554;">
                            <strong style="color: #64ffda;">${user.displayName || user.email}</strong><br>
                            <small style="color: #a8b2d1;">${user.role === 'admin' ? 'Администратор' : 'Охранник'}</small><br>
                            <small style="color: #8892b0;">Ставка: ${user.rate || 0} ₽</small>
                        </div>
                    `).join('');
                }
                
                const paymentSelect = utils.getElement('payment-user-admin');
                if (paymentSelect) {
                    paymentSelect.innerHTML = '<option value="">Выберите охранника</option>';
                    allUsers.forEach(user => {
                        if (user.role !== 'admin') {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = `${user.displayName} (${user.rate || 0} ₽)`;
                            paymentSelect.appendChild(option);
                        }
                    });
                }
                
                if (isAdmin && utils.getElement('tab-shifts-admin')?.classList.contains('active')) {
                    await loadAllShiftsForAdmin();
                }
                
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
            }
        }
        
        // === СОЗДАНИЕ ПОЛЬЗОВАТЕЛЯ ===
        async function createUser() {
            const email = utils.getElement('new-user-email')?.value;
            const password = utils.getElement('new-user-password')?.value;
            const lastName = utils.getElement('new-user-lastname')?.value.trim();
            const firstName = utils.getElement('new-user-firstname')?.value.trim();
            const rate = parseInt(utils.getElement('new-user-rate')?.value) || 1500;
            
            if (!email || !password || !lastName || !firstName) {
                alert('Заполните все поля');
                return;
            }
            
            const fullName = `${lastName} ${firstName}`;
            try {
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email,
                    password
                });
                
                if (authError) throw authError;
                
                const { error: dbError } = await supabase
                    .from('users')
                    .insert([
                        {
                            id: authData.user.id,
                            email,
                            role: 'user',
                            full_name: fullName,
                            last_name: lastName,
                            first_name: firstName,
                            rate,
                            created_at: new Date().toISOString()
                        }
                    ]);
                
                if (dbError) throw dbError;
                
                ['new-user-email', 'new-user-password', 'new-user-lastname', 'new-user-firstname'].forEach(id => {
                    const el = utils.getElement(id);
                    if (el) el.value = '';
                });
                utils.getElement('new-user-rate').value = '1500';
                
                await loadUsers();
                alert(`Охранник ${fullName} создан!`);
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }
        
        // === ЗАГРУЗКА СМЕН ДЛЯ АДМИНА ===
        async function loadAllShiftsForAdmin() {
            try {
                const month = parseInt(utils.getElement('selected-month')?.value || currentMonth);
                const year = parseInt(utils.getElement('selected-year')?.value || currentYear);
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = firstDay.toISOString().split('T')[0];
                const endDate = lastDay.toISOString().split('T')[0];
                
                console.log('Загрузка смен для админа:', { month, year, startDate, endDate });
                
                const { data, error } = await supabase
                    .from('shifts')
                    .select('*')
                    .gte('date', startDate)
                    .lte('date', endDate);
                
                if (error) throw error;
                
                adminShiftsData = {};
                shiftsMap = {};
                currentAdminShifts = {};
                
                data.forEach(shift => {
                    const userId = shift.user_id;
                    const date = shift.date;
                    
                    if (!adminShiftsData[userId]) adminShiftsData[userId] = {};
                    if (!shiftsMap[userId]) shiftsMap[userId] = {};
                    
                    adminShiftsData[userId][date] = {
                        type: shift.type,
                        done: shift.done || false,
                        paid: shift.paid || false,
                        shiftId: shift.id
                    };
                    
                    currentAdminShifts[shift.id] = { ...shift };
                    
                    shiftsMap[userId][date] = {
                        type: shift.type,
                        done: shift.done || false,
                        paid: shift.paid || false
                    };
                });
                
                renderAdminShiftsTable(month, year);
                
            } catch (error) {
                console.error('Ошибка загрузки смен для админа:', error);
                alert('Ошибка загрузки смен: ' + error.message);
            }
        }
        
        // === РЕНДЕР ТАБЛИЦЫ СМЕН АДМИНА ===
        function renderAdminShiftsTable(month, year) {
            const tableBody = utils.getElement('shifts-table-body');
            const daysHeader = utils.getElement('days-header');
            const monthYearHeader = utils.getElement('table-month-year');
            
            if (!tableBody || !daysHeader || !monthYearHeader) return;
            
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                               'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            monthYearHeader.textContent = `${monthNames[month]} ${year}`;
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let daysHtml = '';
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
                
                daysHtml += `<th style="${dayOfWeek === 0 || dayOfWeek === 6 ? 'color: #ff6b6b;' : ''}">
                    ${day}<br><small style="font-size: 0.7rem; color: #8892b0;">${dayNames[dayOfWeek]}</small>
                </th>`;
            }
            
            for (let day = daysInMonth + 1; day <= 31; day++) {
                daysHtml += `<th style="color: #8892b0; opacity: 0.3;"><br><small style="font-size: 0.7rem; color: #8892b0;"></small></th>`;
            }
            
            daysHeader.innerHTML = daysHtml;
            
            const guards = allUsers.filter(user => user.role !== 'admin');
            let tableHtml = '';
            
            guards.forEach((guard, index) => {
                tableHtml += `<tr data-user-id="${guard.id}">`;
                tableHtml += `<td>${index + 1}</td>`;
                tableHtml += `<td><strong>${guard.displayName}</strong><br><small style="color: #8892b0;">${guard.rate || 0} ₽</small></td>`;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const shift = adminShiftsData[guard.id] ? adminShiftsData[guard.id][dateStr] : null;
                    
                    let shiftClass = '';
                    let title = 'Нет смены (клик для добавления)';
                    
                    if (shift) {
                        if (shift.type === 'regular') {
                            if (shift.paid) {
                                shiftClass = 'shift-paid';
                                title = 'Оплаченная обычная смена';
                            } else if (shift.done) {
                                shiftClass = 'shift-done';
                                title = 'Отработанная обычная смена';
                            } else {
                                shiftClass = 'shift-regular';
                                title = 'Обычная смена';
                            }
                        } else if (shift.type === 'extra') {
                            if (shift.paid) {
                                shiftClass = 'shift-paid-extra';
                                title = 'Оплаченная подработка';
                            } else if (shift.done) {
                                shiftClass = 'shift-done-extra';
                                title = 'Отработанная подработка';
                            } else {
                                shiftClass = 'shift-extra';
                                title = 'Подработка';
                            }
                        } else if (shift.type === 'dayoff') {
                            shiftClass = 'shift-dayoff';
                            title = 'Выходной';
                        } else if (shift.type === 'problem') {
                            shiftClass = 'shift-problem';
                            title = 'Проблемная смена';
                        }
                    }
                    
                    const hasShift = shift && shift.shiftId;
                    tableHtml += `
                        <td>
                            <div class="shifts-cell ${shiftClass}" 
                                data-user-id="${guard.id}" 
                                data-date="${dateStr}"
                                data-shift-id="${shift ? shift.shiftId : ''}"
                                data-shift-type="${shift ? shift.type : ''}"
                                data-done="${shift ? shift.done : false}"
                                data-paid="${shift ? shift.paid : false}"
                                title="${title}">
                                ${shift ? '' : '+'}
                                ${hasShift ? '<button class="delete-shift-btn" title="Удалить смену">×</button>' : ''}
                            </div>
                        </td>`;
                }
                
                for (let day = daysInMonth + 1; day <= 31; day++) {
                    tableHtml += `<td style="opacity: 0.3;"></td>`;
                }
                
                tableHtml += `<td style="width: 50px; min-width: 50px; background: transparent;"></td>`;
                
                tableHtml += `</tr>`;
            });
            
            tableBody.innerHTML = tableHtml;
            
            // Добавляем обработчики событий для ячеек смен
            tableBody.querySelectorAll('.shifts-cell').forEach(cell => {
                cell.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('delete-shift-btn')) {
                        handleShiftCellClick(this);
                    }
                });
            });
            
            tableBody.querySelectorAll('.delete-shift-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const cell = this.closest('.shifts-cell');
                    deleteShift(cell);
                });
            });
            
            const scrollLeftBtn = utils.getElement('scroll-left-btn');
            const scrollRightBtn = utils.getElement('scroll-right-btn');
            const tableContainer = document.querySelector('.table-responsive');
            
            if (scrollLeftBtn && tableContainer) {
                scrollLeftBtn.addEventListener('click', () => tableContainer.scrollBy({ left: -200, behavior: 'smooth' }));
            }
            if (scrollRightBtn && tableContainer) {
                scrollRightBtn.addEventListener('click', () => tableContainer.scrollBy({ left: 200, behavior: 'smooth' }));
            }
        }
        
        // === УДАЛЕНИЕ СМЕНЫ ===
        async function deleteShift(cell) {
            const shiftId = cell.getAttribute('data-shift-id');
            const userId = cell.getAttribute('data-user-id');
            const date = cell.getAttribute('data-date');
            
            if (!shiftId) {
                alert('Смены для удаления не существует');
                return;
            }
            
            if (!confirm('Удалить эту смену?')) return;
            
            try {
                const { error } = await supabase
                    .from('shifts')
                    .delete()
                    .eq('id', shiftId);
                
                if (error) throw error;
                
                if (adminShiftsData[userId] && adminShiftsData[userId][date]) {
                    delete adminShiftsData[userId][date];
                }
                if (shiftsMap[userId] && shiftsMap[userId][date]) {
                    delete shiftsMap[userId][date];
                }
                delete currentAdminShifts[shiftId];
                
                cell.className = 'shifts-cell';
                cell.setAttribute('data-shift-type', '');
                cell.setAttribute('data-done', 'false');
                cell.setAttribute('data-paid', 'false');
                cell.setAttribute('data-shift-id', '');
                cell.setAttribute('title', 'Нет смены (клик для добавления)');
                cell.innerHTML = '+';
                
                alert('Смена удалена!');
            } catch (error) {
                alert('Ошибка удаления смены: ' + error.message);
            }
        }
        
        // === ОБРАБОТКА КЛИКА ПО ЯЧЕЙКЕ СМЕНЫ ===
        function handleShiftCellClick(cell) {
            const userId = cell.getAttribute('data-user-id');
            const date = cell.getAttribute('data-date');
            const currentType = cell.getAttribute('data-shift-type');
            const isDone = cell.getAttribute('data-done') === 'true';
            const isPaid = cell.getAttribute('data-paid') === 'true';
            
            if (isPaid) {
                alert('Смена уже оплачена, нельзя изменить');
                return;
            }
            
            const shiftCycle = [
                {type: 'regular', color: 'shift-regular', title: 'Обычная смена'},
                {type: 'extra', color: 'shift-extra', title: 'Подработка'},
                {type: 'dayoff', color: 'shift-dayoff', title: 'Выходной'},
                {type: 'problem', color: 'shift-problem', title: 'Проблемная смена'},
                {type: 'done', color: 'shift-done', title: 'Отработанная обычная'},
                {type: 'done-extra', color: 'shift-done-extra', title: 'Отработанная подработка'},
                null
            ];
            
            let currentIndex = shiftCycle.findIndex(item => item ? item.type === currentType : currentType === '');
            if (currentIndex === -1) currentIndex = shiftCycle.length - 1;
            const nextIndex = (currentIndex + 1) % shiftCycle.length;
            const nextItem = shiftCycle[nextIndex];
            
            cell.className = 'shifts-cell';
            if (nextItem) {
                cell.classList.add(nextItem.color);
                cell.setAttribute('data-shift-type', nextItem.type);
                cell.setAttribute('data-done', nextItem.type === 'done' || nextItem.type === 'done-extra' ? 'true' : 'false');
                cell.setAttribute('title', nextItem.title);
                cell.innerHTML = '';
                cell.innerHTML += '<button class="delete-shift-btn" title="Удалить смену">×</button>';
            } else {
                cell.setAttribute('data-shift-type', '');
                cell.setAttribute('data-done', 'false');
                cell.setAttribute('data-paid', 'false');
                cell.setAttribute('data-shift-id', '');
                cell.setAttribute('title', 'Нет смены (клик для добавления)');
                cell.innerHTML = '+';
            }
            
            if (!adminShiftsData[userId]) adminShiftsData[userId] = {};
            if (!shiftsMap[userId]) shiftsMap[userId] = {};
            
            if (nextItem) {
                let type, done, paid;
                if (nextItem.type === 'regular') { type = 'regular'; done = false; paid = false; }
                else if (nextItem.type === 'extra') { type = 'extra'; done = false; paid = false; }
                else if (nextItem.type === 'dayoff') { type = 'dayoff'; done = false; paid = false; }
                else if (nextItem.type === 'problem') { type = 'problem'; done = false; paid = false; }
                else if (nextItem.type === 'done') { type = 'regular'; done = true; paid = false; }
                else if (nextItem.type === 'done-extra') { type = 'extra'; done = true; paid = false; }
                
                adminShiftsData[userId][date] = { type, done, paid, shiftId: adminShiftsData[userId][date]?.shiftId || null };
                shiftsMap[userId][date] = { type, done, paid };
            } else {
                delete adminShiftsData[userId][date];
                delete shiftsMap[userId][date];
            }
        }
        
        // === СОХРАНЕНИЕ ВСЕХ СМЕН АДМИНА ===
        async function saveAllShifts() {
            try {
                const month = parseInt(utils.getElement('selected-month')?.value || currentMonth);
                const year = parseInt(utils.getElement('selected-year')?.value || currentYear);
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = firstDay.toISOString().split('T')[0];
                const endDate = lastDay.toISOString().split('T')[0];
                
                console.log('Сохранение смен для периода:', startDate, 'до', endDate);
                
                // Получаем существующие смены
                const { data: existingShifts, error: fetchError } = await supabase
                    .from('shifts')
                    .select('*')
                    .gte('date', startDate)
                    .lte('date', endDate);
                
                if (fetchError) throw fetchError;
                
                // Собираем все смены для обработки
                const allShiftsToProcess = [];
                
                for (const userId in adminShiftsData) {
                    const userShifts = adminShiftsData[userId];
                    
                    for (const [date, shift] of Object.entries(userShifts)) {
                        const shiftDate = new Date(date);
                        if (shiftDate.getMonth() === month && shiftDate.getFullYear() === year) {
                            allShiftsToProcess.push({
                                userId,
                                date,
                                shift
                            });
                        }
                    }
                }
                
                console.log('Всего смен для обработки:', allShiftsToProcess.length);
                
                // Для каждой смены проверяем, нужно ли создавать новую или обновлять существующую
                const operations = [];
                
                for (const item of allShiftsToProcess) {
                    const { userId, date, shift } = item;
                    
                    // Ищем существующую смену
                    const existingShift = existingShifts?.find(s => 
                        s.user_id === userId && s.date === date
                    );
                    
                    if (existingShift) {
                        // Обновляем существующую смену
                        operations.push(
                            supabase
                                .from('shifts')
                                .update({
                                    type: shift.type,
                                    done: shift.done || false,
                                    paid: shift.paid || false,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', existingShift.id)
                        );
                    } else {
                        // Создаем новую смену
                        operations.push(
                            supabase
                                .from('shifts')
                                .insert({
                                    user_id: userId,
                                    date,
                                    type: shift.type,
                                    done: shift.done || false,
                                    paid: shift.paid || false,
                                    created_at: new Date().toISOString(),
                                    updated_at: new Date().toISOString()
                                })
                        );
                    }
                }
                
                // Определяем смены для удаления (те, которые есть в базе, но нет в интерфейсе)
                const shiftsToDelete = existingShifts?.filter(existingShift => {
                    const userId = existingShift.user_id;
                    const date = existingShift.date;
                    
                    // Проверяем, есть ли эта смена в текущих данных
                    return !adminShiftsData[userId] || !adminShiftsData[userId][date];
                }) || [];
                
                console.log('Смен для удаления:', shiftsToDelete.length);
                
                // Выполняем операции удаления
                if (shiftsToDelete.length > 0) {
                    for (const shiftToDelete of shiftsToDelete) {
                        const { error: deleteError } = await supabase
                            .from('shifts')
                            .delete()
                            .eq('id', shiftToDelete.id);
                        
                        if (deleteError) {
                            console.error('Ошибка удаления смены:', deleteError);
                            throw deleteError;
                        }
                    }
                }
                
                // Выполняем операции вставки/обновления
                for (const operation of operations) {
                    const { error } = await operation;
                    if (error) {
                        console.error('Ошибка операции смены:', error);
                        throw error;
                    }
                }
                
                alert(`Смены сохранены успешно! Обновлено: ${operations.length} записей, удалено: ${shiftsToDelete.length} записей.`);
                
                // Перезагружаем данные
                await loadAllShiftsForAdmin();
                
            } catch (error) {
                console.error('Ошибка сохранения смен:', error);
                alert('Ошибка сохранения смен: ' + (error.message || 'Неизвестная ошибка'));
            }
        }
        
        // === ОТМЕТИТЬ ПРОШЕДШИЕ СМЕНЫ КАК ОТРАБОТАННЫЕ ===
        async function markPastShiftsAsDone() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];

            try {
                const { data, error } = await supabase
                    .from('shifts')
                    .select('*')
                    .lt('date', todayStr)
                    .eq('done', false)
                    .eq('paid', false)
                    .in('type', ['regular', 'extra']);
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    alert('Нет смен для отметки как отработанные');
                    return;
                }
                
                for (const shift of data) {
                    const { error: updateError } = await supabase
                        .from('shifts')
                        .update({ 
                            done: true, 
                            updated_at: new Date().toISOString() 
                        })
                        .eq('id', shift.id);
                    
                    if (updateError) throw updateError;
                }
                
                alert(`Отмечено как отработанные: ${data.length} смен(ы) до ${todayStr}`);
                
                if (isAdmin && utils.getElement('tab-shifts-admin')?.classList.contains('active')) {
                    await loadAllShiftsForAdmin();
                }
    
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }
        
        // === ЗАГРУЗКА СМЕН ПО КНОПКЕ ===
        async function loadAdminShifts() {
            await loadAllShiftsForAdmin();
        }
        
        // === ЗАГРУЗКА ВСЕХ СМЕН ПОЛЬЗОВАТЕЛЯ ПРИ ВХОДЕ ===
        async function loadUserAllShiftsOnLogin() {
            if (!currentUser) return;
            try {
                const now = new Date();
                const startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                const endDate = new Date(now.getFullYear(), now.getMonth() + 4, 0);
                
                console.log('Загрузка смен пользователя:', currentUser.id, 'период:', startDate, 'до', endDate);
                
                const { data, error } = await supabase
                    .from('shifts')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('date', startDate.toISOString().split('T')[0])
                    .lte('date', endDate.toISOString().split('T')[0]);
                
                if (error) throw error;
                
                if (!shiftsMap[currentUser.id]) shiftsMap[currentUser.id] = {};
                
                data.forEach(shift => {
                    shiftsMap[currentUser.id][shift.date] = {
                        type: shift.type,
                        done: shift.done || false,
                        paid: shift.paid || false
                    };
                });
                
                console.log('Загружено смен для пользователя:', data.length);
                renderUserCalendar(currentMonth, currentYear);
                
            } catch (error) {
                console.error('Ошибка загрузки всех смен:', error);
            }
        }

        // === ЗАГРУЗКА СМЕН ПОЛЬЗОВАТЕЛЯ ДЛЯ ВЫБРАННОГО МЕСЯЦА ===
        async function loadUserShiftsForMonth() {
            if (!currentUser) return;
            try {
                const month = parseInt(utils.getElement('user-selected-month')?.value || userViewMonth);
                const year = parseInt(utils.getElement('user-selected-year')?.value || userViewYear);
                
                const startDate = new Date(year, month - 3, 1);
                const endDate = new Date(year, month + 4, 0);
                
                const { data, error } = await supabase
                    .from('shifts')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('date', startDate.toISOString().split('T')[0])
                    .lte('date', endDate.toISOString().split('T')[0]);
                
                if (error) throw error;
                
                if (!shiftsMap[currentUser.id]) shiftsMap[currentUser.id] = {};
                
                // Очищаем старые данные для этого периода
                Object.keys(shiftsMap[currentUser.id]).forEach(date => {
                    if (date >= startDate.toISOString().split('T')[0] && 
                        date <= endDate.toISOString().split('T')[0]) {
                        delete shiftsMap[currentUser.id][date];
                    }
                });
                
                data.forEach(shift => {
                    shiftsMap[currentUser.id][shift.date] = {
                        type: shift.type,
                        done: shift.done || false,
                        paid: shift.paid || false
                    };
                });
                
                renderUserCalendar(month, year);
                updateUserStats();
                
            } catch (error) {
                console.error('Ошибка загрузки смен:', error);
                alert('Ошибка загрузки смен: ' + error.message);
            }
        }
        
        // === РЕНДЕР КАЛЕНДАРЯ ПОЛЬЗОВАТЕЛЯ ===
        function renderUserCalendar(month, year) {
            const container = utils.getElement('user-calendar');
            if (!container || !currentUser) return;
            
            const today = new Date();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const totalDays = lastDay.getDate();
            const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            
            const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            let html = days.map(day => `<div class="calendar-header">${day}</div>`).join('');
            
            for (let i = 0; i < startDay; i++) html += `<div class="calendar-day"></div>`;
            
            for (let day = 1; day <= totalDays; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const shift = shiftsMap[currentUser.id] ? shiftsMap[currentUser.id][dateStr] : null;
                let shiftClass = '';
                
                if (shift) {
                    if (shift.type === 'regular') {
                        if (shift.paid) shiftClass = 'shift-paid';
                        else if (shift.done) shiftClass = 'shift-done';
                        else shiftClass = 'shift-regular';
                    } else if (shift.type === 'extra') {
                        if (shift.paid) shiftClass = 'shift-paid-extra';
                        else if (shift.done) shiftClass = 'shift-done-extra';
                        else shiftClass = 'shift-extra';
                    } else if (shift.type === 'dayoff') shiftClass = 'shift-dayoff';
                    else if (shift.type === 'problem') shiftClass = 'shift-problem';
                }
                
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                
                html += `
                    <div class="calendar-day" data-date="${dateStr}" style="${isToday ? 'border: 2px solid #64ffda;' : ''}">
                        <div class="day-number" style="${isToday ? 'color: #64ffda; font-size: 1.1rem;' : ''}">${day}</div>
                        ${shift ? `<div class="shift-marker ${shiftClass}"></div>` : ''}
                    </div>
                `;
            }
            
            const totalCells = 35;
            const filledCells = startDay + totalDays;
            for (let i = filledCells; i < totalCells; i++) html += `<div class="calendar-day"></div>`;
            
            container.innerHTML = html;
        }
        
        // === КНОПКИ НАВИГАЦИИ МЕСЯЦА ===
        function goToPrevMonth() {
            let month = parseInt(utils.getElement('user-selected-month').value);
            let year = parseInt(utils.getElement('user-selected-year').value);
            month--;
            if (month < 0) { month = 11; year--; }
            utils.getElement('user-selected-month').value = month;
            utils.getElement('user-selected-year').value = year;
            loadUserShiftsForMonth();
        }
        
        function goToNextMonth() {
            let month = parseInt(utils.getElement('user-selected-month').value);
            let year = parseInt(utils.getElement('user-selected-year').value);
            month++;
            if (month > 11) { month = 0; year++; }
            utils.getElement('user-selected-month').value = month;
            utils.getElement('user-selected-year').value = year;
            loadUserShiftsForMonth();
        }
        
        // === ШАБЛОН ПОСТОВ ===
        function renderPostsTemplate() {
            const container = utils.getElement('posts-template');
            if (!container) return;
            
            let html = '';
            defaultPosts.forEach((item, index) => {
                html += `
                    <tr>
                        <td>${item.number}</td>
                        <td>${item.post}</td>
                        <td>${item.time}</td>
                        <td>
                            <button class="btn-small edit-template-btn" data-index="${index}"><i class="fas fa-edit"></i></button>
                            <button class="btn-small btn-danger delete-template-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
            
            document.querySelectorAll('.edit-template-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    editTemplatePost(index);
                });
            });
            
            document.querySelectorAll('.delete-template-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteTemplatePost(index);
                });
            });
        }
        
        function editTemplatePost(index) {
            const post = defaultPosts[index];
            const newNumber = prompt('Измените номер поста:', post.number);
            if (newNumber !== null) {
                const newPost = prompt('Измените название поста:', post.post);
                if (newPost !== null) {
                    const newTime = prompt('Измените время (формат ЧЧ:ММ):', post.time);
                    if (newTime !== null) {
                        defaultPosts[index] = { number: newNumber, post: newPost, time: newTime };
                        renderPostsTemplate();
                        alert('Шаблон обновлен!');
                    }
                }
            }
        }
        
        function deleteTemplatePost(index) {
            if (confirm('Удалить этот пост из шаблона?')) {
                defaultPosts.splice(index, 1);
                renderPostsTemplate();
                alert('Пост удален из шаблона!');
            }
        }
        
        // === ОБНОВЛЕНИЕ СТАТИСТИКИ ===
        function updateUserStats() {
            if (!currentUser) return;
            const user = allUsers.find(u => u.id === currentUser.id);
            if (!user) return;
            
            const rate = user.rate || 0;
            const shifts = shiftsMap[currentUser.id] || {};
            let regularCount = 0, extraCount = 0, pendingAmount = 0;
            
            Object.values(shifts).forEach(shift => {
                if (shift.type === 'regular' && shift.done && !shift.paid) {
                    regularCount++;
                    pendingAmount += rate;
                } else if (shift.type === 'extra' && shift.done && !shift.paid) {
                    extraCount++;
                    pendingAmount += rate + 100;
                }
            });
            
            const pendingTable = utils.getElement('pending-payments');
            const pendingTotal = utils.getElement('pending-total');
            
            if (pendingTable) {
                if (regularCount === 0 && extraCount === 0) {
                    pendingTable.innerHTML = '<tr><td colspan="4">Нет ожидающих выплат</td></tr>';
                } else {
                    pendingTable.innerHTML = '';
                    if (regularCount > 0) {
                        pendingTable.innerHTML += `
                            <tr>
                                <td>Обычные смены</td>
                                <td>${regularCount}</td>
                                <td>${rate} ₽</td>
                                <td>${regularCount * rate} ₽</td>
                            </tr>
                        `;
                    }
                    if (extraCount > 0) {
                        pendingTable.innerHTML += `
                            <tr>
                                <td>Подработки</td>
                                <td>${extraCount}</td>
                                <td>${rate + 100} ₽</td>
                                <td>${extraCount * (rate + 100)} ₽</td>
                            </tr>
                        `;
                    }
                }
            }
            
            if (pendingTotal) pendingTotal.textContent = `${pendingAmount} ₽`;
            
            const userName = utils.getElement('user-full-name');
            const userPosition = utils.getElement('user-position');
            const userRate = utils.getElement('user-rate');
            const userEmail = utils.getElement('user-email');
            
            if (userName) userName.textContent = user.displayName || user.email || 'Имя не указано';
            if (userPosition) userPosition.textContent = user.role === 'admin' ? 'Администратор' : 'Охранник';
            if (userRate) userRate.textContent = `${rate} ₽`;
            if (userEmail) userEmail.textContent = user.email;
        }
        
        // === АРХИВ ВЫПЛАТ АДМИНА ===
        async function loadPaymentsArchive() {
            try {
                const { data, error } = await supabase
                    .from('salary_payments')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                const container = utils.getElement('payments-archive-admin');
                if (!container) return;
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<tr><td colspan="10">Нет выплат</td></tr>';
                    return;
                }
                
                let html = '';
                data.forEach(payment => {
                    const date = payment.created_at ? new Date(payment.created_at).toLocaleDateString('ru-RU') : 'Дата неизвестна';
                    const user = allUsers.find(u => u.id === payment.user_id);
                    const rate = user ? user.rate : 0;
                    
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>${payment.period_from}<br>${payment.period_to}</td>
                            <td>${payment.user_name || 'Неизвестно'}</td>
                            <td>${payment.regular_shifts || 0}</td>
                            <td>${payment.extra_shifts || 0}</td>
                            <td>${rate} ₽</td>
                            <td>${payment.bonus || 0} ₽</td>
                            <td>${payment.penalty || 0} ₽</td>
                            <td>${payment.bonus_note || ''}</td>
                            <td><strong>${payment.total_amount || 0} ₽</strong></td>
                        </tr>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Ошибка загрузки архива выплат:', error);
            }
        }
        
        // === РАСЧЕТ ВЫПЛАТ АДМИНА ===
        async function calculatePaymentAdmin() {
            const userId = utils.getElement('payment-user-admin')?.value;
            const fromDate = utils.getElement('period-from-admin')?.value;
            const toDate = utils.getElement('period-to-admin')?.value;
            const bonus = parseInt(utils.getElement('bonus-amount-admin')?.value) || 0;
            const penalty = parseInt(utils.getElement('penalty-amount-admin')?.value) || 0;
            const note = utils.getElement('bonus-note-admin')?.value;
            
            if (!userId || !fromDate || !toDate) return alert('Заполните все поля');
            
            const user = allUsers.find(u => u.id === userId);
            if (!user) return alert('Охранник не найден');
            
            const rate = user.rate || 0;
            
            try {
                const { data: shifts, error: shiftsError } = await supabase
                    .from('shifts')
                    .select('*')
                    .eq('user_id', userId)
                    .gte('date', fromDate)
                    .lte('date', toDate)
                    .eq('done', true)
                    .eq('paid', false);
                
                if (shiftsError) throw shiftsError;
                
                let regularCount = 0, extraCount = 0, totalAmount = 0;
                
                shifts.forEach(shift => {
                    if (shift.type === 'regular') {
                        regularCount++;
                        totalAmount += rate;
                    } else if (shift.type === 'extra') {
                        extraCount++;
                        totalAmount += rate + 100;
                    }
                });
                
                if (regularCount === 0 && extraCount === 0) {
                    alert('Нет смен для выплаты в выбранном периоде');
                    return;
                }
                
                const finalAmount = totalAmount + bonus - penalty;
                
                const { error: paymentError } = await supabase
                    .from('salary_payments')
                    .insert([
                        {
                            user_id: userId,
                            user_name: user.displayName || user.email,
                            period_from: fromDate,
                            period_to: toDate,
                            regular_shifts: regularCount,
                            extra_shifts: extraCount,
                            base_amount: totalAmount,
                            bonus: bonus,
                            penalty: penalty,
                            bonus_note: note,
                            total_amount: finalAmount,
                            admin_id: currentUser.id,
                            created_at: new Date().toISOString()
                        }
                    ]);
                
                if (paymentError) throw paymentError;
                
                for (const shift of shifts) {
                    const { error: updateError } = await supabase
                        .from('shifts')
                        .update({ 
                            paid: true,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', shift.id);
                    
                    if (updateError) throw updateError;
                }
                
                utils.getElement('payment-user-admin').value = '';
                utils.getElement('bonus-amount-admin').value = '0';
                utils.getElement('penalty-amount-admin').value = '0';
                utils.getElement('bonus-note-admin').value = '';
                
                const resultDiv = utils.getElement('calculation-result-admin');
                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>Выплата создана!</strong><br>
                            Охранник: ${user.displayName || user.email}<br>
                            Период: ${fromDate} - ${toDate}<br>
                            Обычных: ${regularCount} × ${rate} ₽ = ${regularCount * rate} ₽<br>
                            Подработок: ${extraCount} × ${rate + 100} ₽ = ${extraCount * (rate + 100)} ₽<br>
                            Премия: +${bonus} ₽<br>
                            Удержание: -${penalty} ₽<br>
                            <strong>Итого: ${finalAmount} ₽</strong>
                        </div>
                    `;
                }
                
                await loadPaymentsArchive();
                alert(`Выплата на сумму ${finalAmount} ₽ создана для ${user.displayName}`);
                
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }
        
        // === ИСТОРИЯ ВЫПЛАТ ПОЛЬЗОВАТЕЛЯ ===
        async function loadUserPaymentHistory() {
            if (!currentUser) return;
            try {
                const { data, error } = await supabase
                    .from('salary_payments')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                const container = utils.getElement('payments-history-user');
                if (!container) return;
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<tr><td colspan="9">Нет выплат</td></tr>';
                    return;
                }
                
                const user = allUsers.find(u => u.id === currentUser.id);
                const rate = user ? user.rate : 0;
                
                let html = '';
                data.forEach(payment => {
                    const date = payment.created_at ? new Date(payment.created_at).toLocaleDateString('ru-RU') : 'Дата неизвестна';
                    
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>${payment.period_from}<br>${payment.period_to}</td>
                            <td>${payment.regular_shifts || 0}</td>
                            <td>${payment.extra_shifts || 0}</td>
                            <td>${rate} ₽</td>
                            <td>${payment.bonus || 0} ₽</td>
                            <td>${payment.penalty || 0} ₽</td>
                            <td>${payment.bonus_note || ''}</td>
                            <td><strong>${payment.total_amount || 0} ₽</strong></td>
                        </tr>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Ошибка загрузки истории выплат:', error);
            }
        }
        
        // === ВЫХОД ИЗ СИСТЕМЫ ===
        async function handleLogout() {
            try {
                await supabase.auth.signOut();
                currentUser = null;
                isAdmin = false;
                utils.showSection('welcome-section');
                utils.updateNavigation();
                console.log('Выход выполнен успешно');
            } catch (error) {
                console.error('Ошибка при выходе:', error);
            }
        }
        
        // === ИНИЦИАЛИЗАЦИЯ ===
        async function init() {
            if (isInitialized) return;
            isInitialized = true;
            
            console.log('Инициализация приложения...');
            
            // === ВОССТАНОВЛЕНИЕ СЕССИИ ===
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Ошибка получения сессии:', error);
                    utils.showSection('welcome-section');
                    return;
                }
                
                if (session) {
                    console.log('Сессия восстановлена:', session.user.email);
                    currentUser = session.user;
                    await checkUserRole();
                } else {
                    console.log('Сессия не найдена, показываем приветствие');
                    utils.showSection('welcome-section');
                }
            } catch (error) {
                console.error('Ошибка восстановления сессии:', error);
                utils.showSection('welcome-section');
            }
            
            initTabs();
            
            // Навигация
            utils.safeAddEventListener('nav-home', 'click', (e) => {
                e.preventDefault();
                utils.showSection('welcome-section');
            });
            
            utils.safeAddEventListener('nav-login', 'click', (e) => {
                e.preventDefault();
                utils.showSection('login-section');
            });
            
            utils.safeAddEventListener('nav-admin', 'click', (e) => {
                e.preventDefault();
                utils.showSection('admin-section');
            });
            
            utils.safeAddEventListener('nav-user', 'click', (e) => {
                e.preventDefault();
                utils.showSection('user-section');
            });
            
            utils.safeAddEventListener('nav-logout', 'click', (e) => {
                e.preventDefault();
                handleLogout();
            });
            
            utils.safeAddEventListener('go-to-login', 'click', (e) => {
                e.preventDefault();
                utils.showSection('login-section');
            });
            
            // Авторизация
            utils.safeAddEventListener('login-btn', 'click', handleLogin);
            
            // Админ-панель
            utils.safeAddEventListener('load-all-shifts-btn', 'click', loadAdminShifts);
            utils.safeAddEventListener('mark-done-past', 'click', markPastShiftsAsDone);
            utils.safeAddEventListener('save-all-shifts-btn', 'click', saveAllShifts);
            utils.safeAddEventListener('selected-month', 'change', loadAdminShifts);
            utils.safeAddEventListener('selected-year', 'change', loadAdminShifts);
            utils.safeAddEventListener('calculate-payment-btn-admin', 'click', calculatePaymentAdmin);
            utils.safeAddEventListener('create-user-btn', 'click', createUser);
            
            // Пользовательская панель
            utils.safeAddEventListener('prev-month', 'click', goToPrevMonth);
            utils.safeAddEventListener('next-month', 'click', goToNextMonth);
            utils.safeAddEventListener('load-user-shifts', 'click', loadUserShiftsForMonth);
            utils.safeAddEventListener('user-selected-month', 'change', loadUserShiftsForMonth);
            utils.safeAddEventListener('user-selected-year', 'change', loadUserShiftsForMonth);
            
            // Настройка дат
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            utils.getElement('selected-month').value = currentMonth;
            utils.getElement('selected-year').value = currentYear;
            utils.getElement('user-selected-month').value = currentMonth;
            utils.getElement('user-selected-year').value = currentYear;
            utils.getElement('csv-month').value = currentMonth;
            utils.getElement('csv-year').value = currentYear;
            
            const periodFrom = utils.getElement('period-from-admin');
            const periodTo = utils.getElement('period-to-admin');
            if (periodFrom) periodFrom.valueAsDate = firstDay;
            if (periodTo) periodTo.valueAsDate = today;
            
            const postsDate = utils.getElement('posts-date');
            const userPostsDate = utils.getElement('user-posts-date');
            if (postsDate) postsDate.valueAsDate = today;
            if (userPostsDate) userPostsDate.valueAsDate = today;
            
            renderPostsTemplate();
            
            console.log('Инициализация завершена');
        }
        
        // === СЛУШАТЕЛЬ АУТЕНТИФИКАЦИИ ===
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('Событие аутентификации:', event, 'сессия:', session?.user?.email);
            
            if (session?.user) {
                currentUser = session.user;
                await checkUserRole();
            } else {
                console.log('Пользователь вышел или сессия истекла');
                currentUser = null;
                isAdmin = false;
                utils.updateNavigation();
                
                // Только если пользователь явно вышел, показываем welcome
                if (event === 'SIGNED_OUT') {
                    utils.showSection('welcome-section');
                }
            }
        });
        
        // === ЗАПУСК ===
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
