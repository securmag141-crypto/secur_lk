<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoIP Audio Call</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
</head>
<body>
    <h1>VoIP Audio Call</h1>
    <div id="auth">
        <button id="login1">Login as t1@test.com</button>
        <button id="login2">Login as t2@test.com</button>
        <p id="user"></p>
    </div>
    <div id="call" style="display:none;">
        <button id="callBtn">Call Other User</button>
        <button id="hangupBtn">Hang Up</button>
        <p id="status"></p>
    </div>
    <audio id="remoteAudio" autoplay></audio>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyB_oIgWVcb_56VAdWaVl7GHY3bj75Vt-Wo",
            authDomain: "testcaller-91d8c.firebaseapp.com",
            projectId: "testcaller-91d8c",
            storageBucket: "testcaller-91d8c.firebasestorage.app",
            messagingSenderId: "368258808732",
            appId: "1:368258808732:web:edc101575b7f6266182659"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let localStream;
        let remoteStream;
        let peerConnection;
        let currentUser;
        let otherUser = 't1@test.com' === 't1@test.com' ? 't2@test.com' : 't1@test.com'; // Simple toggle

        // Auth buttons
        document.getElementById('login1').onclick = () => auth.signInWithEmailAndPassword('t1@test.com', '111111');
        document.getElementById('login2').onclick = () => auth.signInWithEmailAndPassword('t2@test.com', '111111');

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user.email;
                document.getElementById('user').textContent = `Logged in as: ${currentUser}`;
                document.getElementById('auth').style.display = 'none';
                document.getElementById('call').style.display = 'block';
                otherUser = currentUser === 't1@test.com' ? 't2@test.com' : 't1@test.com';
                listenForCalls();
            }
        });

        // WebRTC setup
        const servers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        async function createPeerConnection() {
            peerConnection = new RTCPeerConnection(servers);
            remoteStream = new MediaStream();
            document.getElementById('remoteAudio').srcObject = remoteStream;

            peerConnection.ontrack = event => {
                event.streams[0].getTracks().forEach(track => {
                    remoteStream.addTrack(track);
                });
            };

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    db.collection('calls').doc(currentUser).collection('candidates').add(event.candidate.toJSON());
                }
            };
        }

        // Call button
        document.getElementById('callBtn').onclick = async () => {
            document.getElementById('status').textContent = 'Calling...';
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            await createPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            await db.collection('calls').doc(currentUser).set({ offer: offer.toJSON() });
            listenForAnswer();
        };

        // Listen for calls
        function listenForCalls() {
            db.collection('calls').doc(otherUser).onSnapshot(async snapshot => {
                const data = snapshot.data();
                if (data && data.offer && !peerConnection) {
                    document.getElementById('status').textContent = 'Incoming call...';
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    await createPeerConnection();
                    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    await db.collection('calls').doc(otherUser).update({ answer: answer.toJSON() });
                    listenForCandidates(otherUser);
                }
            });
        }

        // Listen for answer
        async function listenForAnswer() {
            db.collection('calls').doc(otherUser).onSnapshot(async snapshot => {
                const data = snapshot.data();
                if (data && data.answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    listenForCandidates(otherUser);
                    document.getElementById('status').textContent = 'Connected';
                }
            });
        }

        // Listen for ICE candidates
        function listenForCandidates(user) {
            db.collection('calls').doc(user).collection('candidates').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                    }
                });
            });
        }

        // Hang up
        document.getElementById('hangupBtn').onclick = () => {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('status').textContent = '';
            db.collection('calls').doc(currentUser).delete();
            db.collection('calls').doc(otherUser).delete();
        };
    </script>
</body>
</html>
