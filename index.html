<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoIP Audio Call</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
</head>
<body>
    <div id="login">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button id="loginBtn">Login</button>
    </div>
    <div id="app" style="display:none;">
        <button id="callBtn">Call t2@test.com</button>
        <button id="hangupBtn">Hangup</button>
        <audio id="remoteAudio" autoplay></audio>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB_oIgWVcb_56VAdWaVl7GHY3bj75Vt-Wo",
            authDomain: "testcaller-91d8c.firebaseapp.com",
            projectId: "testcaller-91d8c",
            storageBucket: "testcaller-91d8c.firebasestorage.app",
            messagingSenderId: "368258808732",
            appId: "1:368258808732:web:edc101575b7f6266182659"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let peerConnection = null;
        let localStream = null;

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                currentUser = auth.currentUser;
                document.getElementById('login').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                listenForCalls();
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        });

        document.getElementById('callBtn').addEventListener('click', async () => {
            if (!currentUser) return;
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            peerConnection = new RTCPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.ontrack = event => {
                document.getElementById('remoteAudio').srcObject = event.streams[0];
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            await db.collection('calls').doc('t2@test.com').set({
                offer: offer,
                from: currentUser.email
            });
        });

        document.getElementById('hangupBtn').addEventListener('click', () => {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            document.getElementById('remoteAudio').srcObject = null;
        });

        async function listenForCalls() {
            db.collection('calls').doc(currentUser.email).onSnapshot(async (doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.offer && !peerConnection) {
                        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        peerConnection = new RTCPeerConnection();
                        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                        peerConnection.ontrack = event => {
                            document.getElementById('remoteAudio').srcObject = event.streams[0];
                        };

                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);

                        await db.collection('calls').doc(data.from).set({
                            answer: answer
                        });
                    }
                    if (data.answer && peerConnection) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                }
            });
        }
    </script>
</body>
</html>
