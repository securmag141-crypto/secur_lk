<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>VoIP Звонок</title>
</head>
<body>
    <h1>Тестовый VoIP Звонок</h1>
    <div id="auth-section">
        <button id="login-t1">Войти как t1</button>
        <button id="login-t2">Войти как t2</button>
    </div>
    <div id="call-section" style="display: none;">
        <p>Вы вошли как: <span id="user-name"></span></p>
        <select id="call-target">
            <option value="t1">Позвонить t1</option>
            <option value="t2">Позвонить t2</option>
        </select>
        <button id="call-btn">Позвонить</button>
        <button id="hangup-btn">Повесить трубку</button>
        <div id="status"></div>
        <audio id="remote-audio" autoplay></audio>
    </div>
    <script type="module">
        // Импорт Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Конфигурация Firebase (замени на свою)
        const firebaseConfig = {
            apiKey: "AIzaSyB_oIgWVcb_56VAdWaVl7GHY3bj75Vt-Wo",
            authDomain: "testcaller-91d8c.firebaseapp.com",
            projectId: "testcaller-91d8c",
            storageBucket: "testcaller-91d8c.firebasestorage.app",
            messagingSenderId: "368258808732",
            appId: "1:368258808732:web:edc101575b7f6266182659"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Элементы DOM
        const loginT1Btn = document.getElementById('login-t1');
        const loginT2Btn = document.getElementById('login-t2');
        const callSection = document.getElementById('call-section');
        const authSection = document.getElementById('auth-section');
        const userNameSpan = document.getElementById('user-name');
        const callTarget = document.getElementById('call-target');
        const callBtn = document.getElementById('call-btn');
        const hangupBtn = document.getElementById('hangup-btn');
        const statusDiv = document.getElementById('status');
        const remoteAudio = document.getElementById('remote-audio');

        let currentUser = null;
        let peerConnection = null;
        let localStream = null;
        let callInProgress = false;

        // STUN-сервер для WebRTC (бесплатный)
        const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // Вход как t1
        loginT1Btn.addEventListener('click', async () => {
            try {
                await signInWithEmailAndPassword(auth, 't1@test.com', '111111');
                currentUser = 't1';
                showCallSection();
                listenForCalls();
            } catch (error) {
                statusDiv.textContent = 'Ошибка входа: ' + error.message;
            }
        });

        // Вход как t2
        loginT2Btn.addEventListener('click', async () => {
            try {
                await signInWithEmailAndPassword(auth, 't2@test.com', '111111');
                currentUser = 't2';
                showCallSection();
                listenForCalls();
            } catch (error) {
                statusDiv.textContent = 'Ошибка входа: ' + error.message;
            }
        });

        function showCallSection() {
            authSection.style.display = 'none';
            callSection.style.display = 'block';
            userNameSpan.textContent = currentUser;
            callTarget.value = currentUser === 't1' ? 't2' : 't1';
        }

        // Слушать входящие звонки
        function listenForCalls() {
            const userDoc = doc(db, 'users', currentUser);
            onSnapshot(userDoc, (snapshot) => {
                const data = snapshot.data();
                if (data && data.offer && !callInProgress) {
                    // Входящий звонок
                    statusDiv.textContent = 'Входящий звонок от ' + data.from + '...';
                    handleIncomingCall(data);
                }
            });
        }

        // Начать звонок
        callBtn.addEventListener('click', async () => {
            const target = callTarget.value;
            if (target === currentUser) return;
            callInProgress = true;
            statusDiv.textContent = 'Звонок ' + target + '...';
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                peerConnection = new RTCPeerConnection(configuration);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                peerConnection.ontrack = (event) => {
                    remoteAudio.srcObject = event.streams[0];
                };
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                await setDoc(doc(db, 'users', target), { offer: offer, from: currentUser });
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        setDoc(doc(db, 'users', target), { ice: event.candidate }, { merge: true });
                    }
                };
            } catch (error) {
                statusDiv.textContent = 'Ошибка звонка: ' + error.message;
                callInProgress = false;
            }
        });

        // Обработать входящий звонок
        async function handleIncomingCall(data) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                peerConnection = new RTCPeerConnection(configuration);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                peerConnection.ontrack = (event) => {
                    remoteAudio.srcObject = event.streams[0];
                };
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                await setDoc(doc(db, 'users', data.from), { answer: answer }, { merge: true });
                callInProgress = true;
                statusDiv.textContent = 'Звонок принят!';
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        setDoc(doc(db, 'users', data.from), { ice: event.candidate }, { merge: true });
                    }
                };
                // Слушать ICE от звонящего
                onSnapshot(doc(db, 'users', currentUser), (snapshot) => {
                    const iceData = snapshot.data();
                    if (iceData && iceData.ice) {
                        peerConnection.addIceCandidate(new RTCIceCandidate(iceData.ice));
                    }
                });
            } catch (error) {
                statusDiv.textContent = 'Ошибка приёма: ' + error.message;
            }
        }

        // Повесить трубку
        hangupBtn.addEventListener('click', async () => {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            await deleteDoc(doc(db, 'users', currentUser));
            callInProgress = false;
            statusDiv.textContent = 'Звонок завершён.';
            remoteAudio.srcObject = null;
        });
    </script>
</body>
</html>
